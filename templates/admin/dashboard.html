{% extends 'admin/base_admin.html' %}

{% block title %}PyCommerce - Admin Dashboard{% endblock %}

{% block dashboard_content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">Dashboard</h1>
    </div>

    <!-- Stats Overview -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card dashboard-card h-100" style="border-left-color: var(--bs-primary);">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted">Revenue</h6>
                            <h2 class="mb-0">${{ dashboard.revenue|default(0)|round(2) }}</h2>
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> 
                                For {{ dashboard.time_period }} period
                            </small>
                        </div>
                        <div>
                            <i class="bi bi-currency-dollar text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card dashboard-card h-100" style="border-left-color: var(--bs-success);">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted">Orders</h6>
                            <h2 class="mb-0">{{ dashboard.orders_count|default(0) }}</h2>
                            <small class="text-muted">
                                <i class="bi bi-clock"></i> 
                                {{ dashboard.orders_pending|default(0) }} pending
                            </small>
                        </div>
                        <div>
                            <i class="bi bi-cart text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card dashboard-card h-100" style="border-left-color: var(--bs-info);">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted">Customers</h6>
                            <h2 class="mb-0">{{ dashboard.customers_count|default(0) }}</h2>
                            <small class="text-muted">
                                <i class="bi bi-person-check"></i> 
                                Total registered
                            </small>
                        </div>
                        <div>
                            <i class="bi bi-people text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card dashboard-card h-100" style="border-left-color: var(--bs-warning);">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted">Products</h6>
                            <h2 class="mb-0">{{ dashboard.products_count|default(0) }}</h2>
                            <small class="text-muted">
                                <i class="bi bi-box"></i> 
                                In catalog
                            </small>
                        </div>
                        <div>
                            <i class="bi bi-box-seam text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <!-- Sales Chart -->
        <div class="col-md-8 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Sales Overview</h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary active">Revenue</button>
                        <button class="btn btn-outline-secondary">Orders</button>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="salesChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <!-- Recent Orders -->
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">Recent Orders</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for order in dashboard.recent_orders %}
                        <a href="/admin/orders/{{ order.id }}" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">Order #{{ order.id|truncate(8, true, '') }}</h6>
                                <small class="text-muted">{{ order.created_at|default('N/A')|string|truncate(16, true, '') }}</small>
                            </div>
                            <p class="mb-1">${{ order.total|default(0)|round(2) }}</p>
                            <small>
                                {% if order.status == 'PENDING' %}
                                <span class="badge bg-warning">Pending</span>
                                {% elif order.status == 'PROCESSING' %}
                                <span class="badge bg-info">Processing</span>
                                {% elif order.status == 'PAID' %}
                                <span class="badge bg-success">Paid</span>
                                {% elif order.status == 'SHIPPED' %}
                                <span class="badge bg-primary">Shipped</span>
                                {% elif order.status == 'DELIVERED' %}
                                <span class="badge bg-primary">Delivered</span>
                                {% elif order.status == 'COMPLETED' %}
                                <span class="badge bg-success">Completed</span>
                                {% elif order.status == 'CANCELLED' %}
                                <span class="badge bg-danger">Cancelled</span>
                                {% elif order.status == 'REFUNDED' %}
                                <span class="badge bg-danger">Refunded</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ order.status }}</span>
                                {% endif %}
                                {{ order.customer_name|default('Customer')|truncate(20, true, '...') }}
                            </small>
                        </a>
                        {% else %}
                        <div class="list-group-item">
                            <p class="text-center text-muted my-3">No recent orders found</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="card-footer text-center">
                    <a href="/admin/orders" class="btn btn-sm btn-outline-primary">View All Orders</a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Top Products -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">Top Products</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Price</th>
                                    <th>Sold</th>
                                    <th>Revenue</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in dashboard.sales_data.top_products %}
                                <tr>
                                    <td>{{ product.name|default('Unknown')|truncate(30, true, '...') }}</td>
                                    <td>${{ product.price|default(0)|round(2) }}</td>
                                    <td>{{ product.quantity|default(0) }}</td>
                                    <td>${{ product.revenue|default(0)|round(2) }}</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-center py-3">No product data available for this period</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer text-center">
                    <a href="/admin/products" class="btn btn-sm btn-outline-primary">View All Products</a>
                </div>
            </div>
        </div>

        <!-- Store Performance -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">Store Performance</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Store</th>
                                <th>Orders</th>
                                <th>Revenue</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for tenant in tenants %}
                            <tr>
                                <td>{{ tenant.name }}</td>
                                <td>{{ tenant.orders_count|default(0) }}</td>
                                <td>${{ tenant.revenue|default(0) }}</td>
                                <td>
                                    {% if tenant.active %}
                                    <span class="badge bg-success">Active</span>
                                    {% else %}
                                    <span class="badge bg-danger">Inactive</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center">No stores found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="card-footer text-center">
                    <a href="/admin/stores" class="btn btn-sm btn-outline-primary">Manage Stores</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock dashboard_content %}

{% block scripts %}
<script>
    // Initialize Sales Chart with dynamic data
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('salesChart');
        let salesChart;
        let chartType = 'revenue'; // Default to revenue view

        // Initial data from server
        const salesData = {
            labels: {{ dashboard.sales_data.dates|tojson }},
            revenueData: {{ dashboard.sales_data.revenue_data|tojson }},
            ordersData: {{ dashboard.sales_data.orders_data|tojson }}
        };

        // Initialize chart
        if (ctx) {
            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: salesData.labels,
                    datasets: [{
                        label: 'Revenue',
                        data: salesData.revenueData,
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (chartType === 'revenue') {
                                        return '$ ' + context.raw.toFixed(2);
                                    } else {
                                        return context.raw + ' orders';
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                drawBorder: false
                            },
                            ticks: {
                                callback: function(value) {
                                    if (chartType === 'revenue') {
                                        return '$ ' + value;
                                    } else {
                                        return value;
                                    }
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Toggle between revenue and orders view
        const revenueBtn = document.querySelector('.btn-group .btn:first-child');
        const ordersBtn = document.querySelector('.btn-group .btn:last-child');

        if (revenueBtn && ordersBtn) {
            revenueBtn.addEventListener('click', function() {
                if (!this.classList.contains('active')) {
                    // Update UI
                    this.classList.add('active');
                    ordersBtn.classList.remove('active');

                    // Update chart
                    chartType = 'revenue';
                    salesChart.data.datasets[0].label = 'Revenue';
                    salesChart.data.datasets[0].data = salesData.revenueData;
                    salesChart.data.datasets[0].borderColor = '#0d6efd';
                    salesChart.data.datasets[0].backgroundColor = 'rgba(13, 110, 253, 0.1)';
                    salesChart.update();
                }
            });

            ordersBtn.addEventListener('click', function() {
                if (!this.classList.contains('active')) {
                    // Update UI
                    this.classList.add('active');
                    revenueBtn.classList.remove('active');

                    // Update chart
                    chartType = 'orders';
                    salesChart.data.datasets[0].label = 'Orders';
                    salesChart.data.datasets[0].data = salesData.ordersData;
                    salesChart.data.datasets[0].borderColor = '#198754';
                    salesChart.data.datasets[0].backgroundColor = 'rgba(25, 135, 84, 0.1)';
                    salesChart.update();
                }
            });
        }

        // Time period selector functionality
        const timePeriodSelect = document.getElementById('time-period');
        const refreshButton = document.getElementById('refresh-dashboard');

        if (timePeriodSelect) {
            timePeriodSelect.addEventListener('change', function() {
                window.location.href = `/admin/dashboard?time_period=${this.value}`;
            });
        }

        if (refreshButton) {
            refreshButton.addEventListener('click', function() {
                const selectedPeriod = timePeriodSelect ? timePeriodSelect.value : 'last7days';
                window.location.href = `/admin/dashboard?time_period=${selectedPeriod}`;
            });
        }
    });
</script>
{% endblock %}