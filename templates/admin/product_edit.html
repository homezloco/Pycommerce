{% extends 'base.html' %}

{% block title %}PyCommerce - Edit Product: {{ product.name }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">Edit Product: {{ product.name }}</h1>
        <a href="/admin/products" class="btn btn-outline-secondary">Back to Products</a>
    </div>
    
    {% if status_message %}
    <div class="alert alert-{{ status_type }}">{{ status_message }}</div>
    {% endif %}
    
    <style>
        .quill-container {
            min-height: 250px;
            margin-bottom: 20px;
        }
    </style>
    
    <div class="card shadow-sm">
        <div class="card-body">
            <form action="/admin/products/update/{{ product.id }}" method="post">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="tenant_id" class="form-label">Store</label>
                            <select class="form-select" id="tenant_id" name="tenant_id" required>
                                {% for t in tenants %}
                                <option value="{{ t.id }}" {% if product.tenant_id == t.id %}selected{% endif %}>{{ t.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="name" class="form-label">Product Name</label>
                            <input type="text" class="form-control" id="name" name="name" value="{{ product.name }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="sku" class="form-label">SKU</label>
                            <input type="text" class="form-control" id="sku" name="sku" value="{{ product.sku }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="price" class="form-label">Price</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="price" name="price" min="0" step="0.01" 
                                       value="{{ product.price }}" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="stock" class="form-label">Stock</label>
                            <input type="number" class="form-control" id="stock" name="stock" min="0" step="1" 
                                   value="{{ product.stock }}" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="categories" class="form-label">Categories</label>
                            <input type="text" class="form-control" id="categories" name="categories" 
                                   value="{{ product.categories|join(', ') }}" 
                                   placeholder="Comma-separated list (e.g., electronics, gadgets)">
                            <div class="form-text">Separate multiple categories with commas</div>
                        </div>
                        <div class="mb-3">
                            <label for="image_url" class="form-label">Product Image (Optional)</label>
                            <div class="input-group">
                                <input type="url" class="form-control" id="image_url" name="image_url" 
                                       value="{{ product.image_url }}" placeholder="Enter image URL or select from media library">
                                <button class="btn btn-outline-secondary" type="button" id="mediaManagerBtn">
                                    <i class="bi bi-images"></i> Media Library
                                </button>
                            </div>
                            <div class="form-text">Enter a URL or select an image from the media library</div>
                            {% if product.image_url %}
                            <div class="mt-2">
                                <img src="{{ product.image_url }}" alt="{{ product.name }}" id="productImagePreview" class="img-thumbnail" style="max-height: 100px;">
                            </div>
                            {% else %}
                            <div class="mt-2">
                                <img src="" alt="No image selected" id="productImagePreview" class="img-thumbnail d-none" style="max-height: 100px;">
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Media Library Modal -->
                        <div class="modal fade" id="mediaLibraryModal" tabindex="-1" aria-labelledby="mediaLibraryModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="mediaLibraryModalLabel">Media Library</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <!-- Upload Section -->
                                        <div class="mb-4 border-bottom pb-3">
                                            <h6 class="mb-3">Upload New Image</h6>
                                            <form id="uploadMediaForm" enctype="multipart/form-data">
                                                <div class="row g-3 align-items-center">
                                                    <div class="col-md-5">
                                                        <input type="file" class="form-control" id="mediaFile" name="file" accept="image/*" required>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <input type="text" class="form-control" id="mediaName" name="name" placeholder="Image name (optional)">
                                                    </div>
                                                    <div class="col-md-3">
                                                        <button type="submit" class="btn btn-primary w-100" id="uploadMediaBtn">
                                                            <i class="bi bi-upload"></i> Upload
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="mt-2" id="uploadStatus" style="display: none;"></div>
                                            </form>
                                        </div>
                                        
                                        <!-- Media Library Section -->
                                        <h6 class="mb-3">Available Media</h6>
                                        <div class="row" id="mediaLibraryContainer">
                                            <div class="col-12 text-center py-5" id="mediaLoading">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <p class="mt-2">Loading media...</p>
                                            </div>
                                            <div class="col-12" id="mediaLoadError" style="display: none;">
                                                <div class="alert alert-danger">
                                                    Error loading media. Please try again.
                                                </div>
                                            </div>
                                            <div class="row" id="mediaItems"></div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control quill-editor" id="description" name="description" rows="8">{{ product.description }}</textarea>
                        </div>
                    </div>
                </div>
                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                    <a href="/admin/products" class="btn btn-secondary me-md-2">Cancel</a>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Setup for AI Modal
        const aiModal = document.getElementById('aiModal');
        if (aiModal) {
            // Ensure it's properly initialized with Bootstrap
            new bootstrap.Modal(aiModal);

            // Make sure the close button works
            const closeButtons = aiModal.querySelectorAll('[data-bs-dismiss="modal"]');
            closeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    bootstrap.Modal.getInstance(aiModal).hide();
                });
            });
        }
        
        // Media Library Modal functionality
        const mediaLibraryModal = document.getElementById('mediaLibraryModal');
        const mediaLibraryBtn = document.getElementById('mediaManagerBtn');
        const mediaItems = document.getElementById('mediaItems');
        const mediaLoading = document.getElementById('mediaLoading');
        const mediaLoadError = document.getElementById('mediaLoadError');
        const imageUrlInput = document.getElementById('image_url');
        const productImagePreview = document.getElementById('productImagePreview');
        
        if (mediaLibraryModal && mediaLibraryBtn) {
            // Create Bootstrap modal instance
            const mediaModalInstance = new bootstrap.Modal(mediaLibraryModal);
            
            // Open modal when button is clicked
            mediaLibraryBtn.addEventListener('click', function() {
                loadMediaLibrary();
                mediaModalInstance.show();
            });
            
            // Update preview when URL changes
            if (imageUrlInput && productImagePreview) {
                imageUrlInput.addEventListener('input', function() {
                    updateImagePreview(this.value);
                });
                
                // Initialize preview
                updateImagePreview(imageUrlInput.value);
            }
        }
        
        // Function to update image preview
        function updateImagePreview(url) {
            if (url && url.trim() !== '') {
                productImagePreview.src = url;
                productImagePreview.classList.remove('d-none');
            } else {
                productImagePreview.classList.add('d-none');
            }
        }
        
        // Setup upload form
        const uploadForm = document.getElementById('uploadMediaForm');
        const uploadStatus = document.getElementById('uploadStatus');
        
        if (uploadForm) {
            uploadForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Get form data
                const formData = new FormData(this);
                const fileInput = document.getElementById('mediaFile');
                const nameInput = document.getElementById('mediaName');
                const uploadBtn = document.getElementById('uploadMediaBtn');
                
                // Validate file
                if (!fileInput.files[0]) {
                    showUploadStatus('Please select a file to upload.', 'danger');
                    return;
                }
                
                // If name is not provided, use filename
                if (!nameInput.value.trim()) {
                    formData.set('name', fileInput.files[0].name);
                }
                
                // Show loading state
                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Uploading...';
                showUploadStatus('Uploading image...', 'info');
                
                // Handle simulated upload
                simulateFileUpload(formData, fileInput)
                    .then(response => {
                        showUploadStatus('Image uploaded successfully!', 'success');
                        
                        // Refresh media library
                        loadMediaLibrary();
                        
                        // Reset form
                        uploadForm.reset();
                    })
                    .catch(error => {
                        showUploadStatus('Error uploading image: ' + error.message, 'danger');
                    })
                    .finally(() => {
                        // Reset button
                        uploadBtn.disabled = false;
                        uploadBtn.innerHTML = '<i class="bi bi-upload"></i> Upload';
                    });
            });
        }
        
        // Function to show upload status
        function showUploadStatus(message, type) {
            uploadStatus.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            uploadStatus.style.display = 'block';
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    uploadStatus.style.display = 'none';
                }, 5000);
            }
        }
        
        // Function to simulate file upload
        function simulateFileUpload(formData, fileInput) {
            return new Promise((resolve, reject) => {
                // Create a timeout to simulate network request
                setTimeout(() => {
                    // Simulate successful upload with 90% chance
                    if (Math.random() < 0.9) {
                        // Use FileReader to preview the image
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            // Add image to our sample data
                            const newImage = {
                                id: "upload_" + new Date().getTime(),
                                name: formData.get('name'),
                                url: e.target.result, // Use the Data URL
                                size: fileInput.files[0].size,
                                mime_type: fileInput.files[0].type,
                                tenant_id: null,
                                sharing_level: "global",
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            };
                            
                            // Add to existing sampleMediaData
                            sampleMediaData.items.unshift(newImage);
                            sampleMediaData.count += 1;
                            
                            resolve({ success: true, image: newImage });
                        };
                        
                        // Read the image as a Data URL
                        reader.readAsDataURL(fileInput.files[0]);
                    } else {
                        // Simulate error
                        reject(new Error("Server error, please try again."));
                    }
                }, 1500); // Simulate 1.5s upload time
            });
        }
        
        // Sample media data
        const sampleMediaData = {
            items: [
                {
                    id: "1",
                    name: "Sample Image 1",
                    url: "https://via.placeholder.com/600x400/4a90e2/ffffff?text=Product+Image+1",
                    size: 12345,
                    mime_type: "image/jpeg",
                    tenant_id: null,
                    sharing_level: "global",
                    created_at: "2025-04-23T10:00:00Z",
                    updated_at: "2025-04-23T10:00:00Z"
                },
                {
                    id: "2",
                    name: "Tech Product Image", 
                    url: "https://via.placeholder.com/600x400/e24a90/ffffff?text=Tech+Product",
                    size: 23456,
                    mime_type: "image/jpeg",
                    tenant_id: "tech",
                    sharing_level: "tenant",
                    created_at: "2025-04-23T10:01:00Z",
                    updated_at: "2025-04-23T10:01:00Z"
                },
                {
                    id: "3",
                    name: "Outdoor Product Image",
                    url: "https://via.placeholder.com/600x400/90e24a/ffffff?text=Outdoor+Product",
                    size: 34567,
                    mime_type: "image/jpeg",
                    tenant_id: "outdoor",
                    sharing_level: "tenant",
                    created_at: "2025-04-23T10:02:00Z",
                    updated_at: "2025-04-23T10:02:00Z"
                },
                {
                    id: "4",
                    name: "Fashion Product Image",
                    url: "https://via.placeholder.com/600x400/e2904a/ffffff?text=Fashion+Product",
                    size: 45678,
                    mime_type: "image/jpeg",
                    tenant_id: "fashion",
                    sharing_level: "tenant",
                    created_at: "2025-04-23T10:03:00Z",
                    updated_at: "2025-04-23T10:03:00Z"
                }
            ],
            count: 4,
            page: 1,
            limit: 100
        };
        
        // Function to load media library
        function loadMediaLibrary() {
            // Show loading state
            mediaLoading.style.display = 'block';
            mediaLoadError.style.display = 'none';
            mediaItems.innerHTML = '';
            
            // Display sample data
            setTimeout(() => {
                mediaLoading.style.display = 'none';
                
                // Render media items
                if (sampleMediaData && sampleMediaData.items && sampleMediaData.items.length > 0) {
                    sampleMediaData.items.forEach(item => {
                        const mediaItem = document.createElement('div');
                        mediaItem.className = 'col-md-3 mb-3';
                        mediaItem.innerHTML = `
                            <div class="card h-100">
                                <img src="${item.url}" class="card-img-top" alt="${item.name}" style="height: 100px; object-fit: cover;">
                                <div class="card-body">
                                    <h6 class="card-title text-truncate">${item.name}</h6>
                                    <button type="button" class="btn btn-sm btn-primary select-media" data-url="${item.url}">Select</button>
                                </div>
                            </div>
                        `;
                        mediaItems.appendChild(mediaItem);
                    });
                    
                    // Add event listeners to select buttons
                    document.querySelectorAll('.select-media').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const url = this.getAttribute('data-url');
                            imageUrlInput.value = url;
                            updateImagePreview(url);
                            // Use the Bootstrap modal API to find and hide the modal
                            const modal = bootstrap.Modal.getInstance(mediaLibraryModal);
                            if (modal) {
                                modal.hide();
                            }
                        });
                    });
                } else {
                    mediaItems.innerHTML = '<div class="col-12"><div class="alert alert-info">No media found. Upload some images first.</div></div>';
                }
            }, 1000); // Simulate network delay
        }
    });
</script>
{% endblock %}

<!-- AI Content Generation Modal -->
<div class="modal fade" id="aiModal" tabindex="-1" aria-labelledby="aiModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="aiModalLabel">Generate Content with AI</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="aiPromptInput" class="form-label">What would you like to generate?</label>
                    <textarea class="form-control" id="aiPromptInput" rows="4" placeholder="E.g., Write a detailed product description for a waterproof smartwatch that tracks swimming metrics"></textarea>
                </div>
                <div id="aiModalLoading" class="text-center d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Generating content with AI...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="aiGenerateBtn">Generate</button>
            </div>
        </div>
    </div>
</div>