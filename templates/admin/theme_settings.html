{% extends "admin/base_admin.html" %}

{% block title %}Theme Settings - PyCommerce Admin{% endblock %}

{% block admin_content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">Theme Settings</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="/admin">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="/admin/stores">Stores</a></li>
        <li class="breadcrumb-item active">Theme Settings</li>
    </ol>

    {% if error %}
    <div class="alert alert-danger" role="alert">
        {{ error }}
    </div>
    {% endif %}

    {% if success %}
    <div class="alert alert-success" role="alert">
        {{ success }}
    </div>
    {% endif %}

    <div class="card mb-4">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-paint-brush me-1"></i>
                    Theme Settings for {{ tenant.name }}
                </div>

            </div>
        </div>
        <div class="card-body">
            <form method="POST" action="/admin/theme-settings">

                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0">Store Elements</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-4">
                                    <label class="form-label">Store Logo</label>
                                    <div class="d-flex mb-2">
                                        {% if theme.logo_url %}
                                        <div class="border p-2 mb-2 me-3" style="width: 100px; height: 100px; background-color: #f8f9fa;">
                                            <img src="{{ theme.logo_url }}" alt="Current Logo" class="img-fluid" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                                        </div>
                                        {% endif %}
                                        <div>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="logo_url" name="logo_url" 
                                                    value="{{ theme.logo_url|default('') }}" placeholder="Logo URL">
                                                <button class="btn btn-outline-secondary" type="button" 
                                                    onclick="openMediaSelector('logo_url')">Browse Media</button>
                                            </div>
                                            <div class="form-text">Enter a URL or select from media library</div>
                                            {% if theme.logo_url %}
                                            <div class="mt-2">
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                    onclick="document.getElementById('logo_url').value = ''">
                                                    Remove Logo
                                                </button>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <label for="logo_position" class="form-label">Logo Position</label>
                                        <select class="form-select" id="logo_position" name="logo_position">
                                            <option value="left" {% if theme.logo_position == 'left' or not theme.logo_position %}selected{% endif %}>Left</option>
                                            <option value="center" {% if theme.logo_position == 'center' %}selected{% endif %}>Center</option>
                                            <option value="right" {% if theme.logo_position == 'right' %}selected{% endif %}>Right</option>
                                        </select>
                                        <div class="form-text">Position of the logo in the header</div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="header_style" class="form-label">Header Style</label>
                                    <select class="form-select" id="header_style" name="header_style">
                                        <option value="standard" {% if theme.header_style == 'standard' or not theme.header_style %}selected{% endif %}>Standard</option>
                                        <option value="minimal" {% if theme.header_style == 'minimal' %}selected{% endif %}>Minimal</option>
                                        <option value="centered" {% if theme.header_style == 'centered' %}selected{% endif %}>Centered</option>
                                        <option value="expanded" {% if theme.header_style == 'expanded' %}selected{% endif %}>Expanded</option>
                                        <option value="expanded" {% if theme.header_style == 'expanded' %}selected{% endif %}>Expanded</option>
                                    </select>
                                    <div class="form-text">Style and layout of the store header</div>
                                </div>
                                <div class="mb-3">
                                    <label for="product_card_style" class="form-label">Product Card Style</label>
                                    <select class="form-select" id="product_card_style" name="product_card_style">
                                        <option value="standard" {% if theme.product_card_style == 'standard' or not theme.product_card_style %}selected{% endif %}>Standard</option>
                                        <option value="compact" {% if theme.product_card_style == 'compact' %}selected{% endif %}>Compact</option>
                                        <option value="minimal" {% if theme.product_card_style == 'minimal' %}selected{% endif %}>Minimal</option>
                                        <option value="detailed" {% if theme.product_card_style == 'detailed' %}selected{% endif %}>Detailed</option>
                                    </select>
                                    <div class="form-text">Style of product cards in listings</div>
                                </div>
                                <div class="mb-3">
                                    <label for="button_style" class="form-label">Button Style</label>
                                    <select class="form-select" id="button_style" name="button_style">
                                        <option value="standard" {% if theme.button_style == 'standard' or not theme.button_style %}selected{% endif %}>Standard</option>
                                        <option value="rounded" {% if theme.button_style == 'rounded' %}selected{% endif %}>Rounded</option>
                                        <option value="pill" {% if theme.button_style == 'pill' %}selected{% endif %}>Pill</option>
                                        <option value="square" {% if theme.button_style == 'square' %}selected{% endif %}>Square</option>
                                    </select>
                                    <div class="form-text">Shape and style of buttons throughout the store</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Custom CSS</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="custom_css" class="form-label">Custom CSS</label>
                                    <textarea class="form-control" id="custom_css" name="custom_css" rows="6" 
                                        placeholder="/* Add your custom CSS here */">{{ theme.custom_css|default('') }}</textarea>
                                    <div class="form-text">Add custom CSS to further customize your store theme</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-between">
                    <div>
                        <a href="/admin/stores" class="btn btn-secondary">Cancel</a>
                    </div>
                    <div>
                        <button type="submit" class="btn btn-primary">Save Theme Settings</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Theme Preview Section -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-eye me-1"></i>
            Theme Preview
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                The theme preview will show how your store will look with the selected theme settings. Save your changes to update the actual store.
            </div>
            <div class="text-center">
                <a href="/store/{{ tenant.slug }}" target="_blank" class="btn btn-primary">
                    <i class="fas fa-external-link-alt me-1"></i>
                    View Store
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Media Selector Modal -->
<div class="modal fade" id="mediaSelectorModal" tabindex="-1" aria-labelledby="mediaSelectorLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mediaSelectorLabel">Select Media</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" id="searchMedia" placeholder="Search media...">
                            <button class="btn btn-outline-secondary" type="button" id="searchMediaBtn">Search</button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterMediaType">
                            <option value="">All Types</option>
                            <option value="image" selected>Images</option>
                            <option value="video">Videos</option>
                            <option value="audio">Audio</option>
                            <option value="application">Documents</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <div class="d-grid">
                            <button class="btn btn-primary" type="button" onclick="window.location.href='/admin/media'">
                                <i class="fas fa-photo-video me-1"></i> Manage Media
                            </button>
                        </div>
                    </div>
                </div>
                <div id="mediaSelectorGrid" class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3">
                    <!-- Media items will be loaded here via JavaScript -->
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading media...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Update border radius value display
    const borderRadiusSlider = document.getElementById('border_radius');
    const borderRadiusValue = document.getElementById('border_radius_value');

    if (borderRadiusSlider && borderRadiusValue) {
        borderRadiusSlider.addEventListener('input', function() {
            borderRadiusValue.textContent = this.value + 'px';
        });
    }

    // Sync color input with text input
    const colorInputs = document.querySelectorAll('input[type="color"]');
    colorInputs.forEach(input => {
        const inputId = input.id;
        const textInput = input.nextElementSibling;

        if (textInput) {
            input.addEventListener('input', function() {
                textInput.value = this.value;
            });
        }
    });
});

// Function to open the media selector and handle selection
function openMediaSelector(targetFieldId) {
    // Show the media selector modal
    const mediaSelectorModal = new bootstrap.Modal(document.getElementById('mediaSelectorModal'));

    // Define the callback function that will be called when media is selected
    window.mediaSelectionCallback = function(id, url, name) {
        // Update the target input field with the selected media URL
        document.getElementById(targetFieldId).value = url;

        // Close the media selector modal
        mediaSelectorModal.hide();
    };

    // Load media content into the selector
    if (typeof window.loadMediaSelector === 'function') {
        window.loadMediaSelector(window.mediaSelectionCallback);
    } else {
        // If the loadMediaSelector function is not available, show the modal directly
        mediaSelectorModal.show();

        // Fetch media items from the API
        fetch('/admin/media')
            .then(response => response.text())
            .then(html => {
                // Extract the media items from the HTML response
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const mediaItems = doc.querySelectorAll('.media-card');
                const mediaGrid = document.getElementById('mediaSelectorGrid');

                if (mediaItems && mediaItems.length > 0) {
                    let html = '';
                    mediaItems.forEach(item => {
                        const imgElement = item.querySelector('img');
                        const titleElement = item.querySelector('.card-title');

                        if (imgElement && titleElement) {
                            const imgSrc = imgElement.src;
                            const itemName = titleElement.textContent.trim();
                            const itemId = item.getAttribute('data-media-id') || 'unknown';

                            html += `
                                <div class="col">
                                    <div class="card h-100">
                                        <img src="${imgSrc}" class="card-img-top" alt="${itemName}" style="height: 160px; object-fit: contain;">
                                        <div class="card-body">
                                            <h6 class="card-title text-truncate">${itemName}</h6>
                                            <button class="btn btn-sm btn-primary w-100" onclick="selectMedia('${itemId}', '${imgSrc}', '${itemName}')">Select</button>
                                        </div>
                                    </div>
                                </div>`;
                        }
                    });

                    if (html) {
                        mediaGrid.innerHTML = html;
                    } else {
                        loadFallbackImages(mediaGrid);
                    }
                } else {
                    loadFallbackImages(mediaGrid);
                }
            })
            .catch(error => {
                console.error('Error loading media:', error);
                // Try direct access to the static media as fallback
                fetch('/admin/media')
                    .then(response => response.text())
                    .then(html => {
                        // Try to extract the images from the HTML
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const mediaItems = doc.querySelectorAll('.media-card');

                        if (mediaItems && mediaItems.length > 0) {
                            let html = '';
                            mediaItems.forEach(item => {
                                const imgElement = item.querySelector('img');
                                const titleElement = item.querySelector('.card-title');

                                if (imgElement && titleElement) {
                                    const imgSrc = imgElement.src;
                                    const itemName = titleElement.textContent.trim();
                                    const itemId = item.getAttribute('data-media-id') || 'unknown';

                                    html += `
                                        <div class="col">
                                            <div class="card h-100">
                                                <img src="${imgSrc}" class="card-img-top" alt="${itemName}" style="height: 160px; object-fit: contain;">
                                                <div class="card-body">
                                                    <h6 class="card-title text-truncate">${itemName}</h6>
                                                    <button class="btn btn-sm btn-primary w-100" onclick="selectMedia('${itemId}', '${imgSrc}', '${itemName}')">Select</button>
                                                </div>
                                            </div>
                                        </div>`;
                                }
                            });

                            if (html) {
                                mediaGrid.innerHTML = html;
                            } else {
                                loadFallbackImages(mediaGrid);
                            }
                        } else {
                            loadFallbackImages(mediaGrid);
                        }
                    })
                    .catch(error => {
                        console.error('Error parsing media page:', error);
                        loadFallbackImages(mediaGrid);
                    });
            });
    }
}

// Function to handle media selection from the modal
function selectMedia(id, url, name) {
    // Check if we're in a callback context
    if (window.mediaSelectionCallback) {
        window.mediaSelectionCallback(id, url, name);
    } else {
        // If no callback is set, just copy the URL to clipboard
        navigator.clipboard.writeText(url).then(() => {
            alert(`URL copied to clipboard: ${url}`);
        });
    }
}

// Function to load fallback images from the static directory
function loadFallbackImages(mediaGrid) {
    // We know these images exist from your static/media/generated folder
    const staticMediaItems = [
        { id: '1', file_url: '/static/media/generated/0c4f7a9d-297d-4a51-a49d-feec90488953.png', name: 'Generated Image 1' },
        { id: '2', file_url: '/static/media/generated/768b62a9-887c-4111-b4be-3b08c6a96337.png', name: 'Generated Image 2' },
        { id: '3', file_url: '/static/media/generated/aebea84c-fb36-40f2-8efd-7712dda99bc9.png', name: 'Generated Image 3' }
    ];

    let html = '';
    staticMediaItems.forEach(item => {
        html += `
            <div class="col">
                <div class="card h-100">
                    <img src="${item.file_url}" class="card-img-top" alt="${item.name}" style="height: 160px; object-fit: contain;">
                    <div class="card-body">
                        <h6 class="card-title text-truncate">${item.name}</h6>
                        <button class="btn btn-sm btn-primary w-100" onclick="selectMedia('${item.id}', '${item.file_url}', '${item.name}')">Select</button>
                    </div>
                </div>
            </div>`;
    });

    if (html) {
        mediaGrid.innerHTML = html;
    } else {
        mediaGrid.innerHTML = '<div class="col-12 text-center py-5"><p>No media found. Please upload some images first.</p></div>';
    }
}
</script>
{% endblock admin_content %}