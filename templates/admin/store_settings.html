{% extends "admin/base_admin.html" %}

{% block title %}Store Settings{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">Store Settings</h1>
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-cog me-1"></i>
            Store Configuration
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="nav flex-column nav-pills me-3" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                        <button class="nav-link active" id="v-pills-basic-tab" data-bs-toggle="pill" data-bs-target="#v-pills-basic" type="button" role="tab" aria-controls="v-pills-basic" aria-selected="true">Basic Settings</button>
                        <button class="nav-link" id="v-pills-domains-tab" data-bs-toggle="pill" data-bs-target="#v-pills-domains" type="button" role="tab" aria-controls="v-pills-domains" aria-selected="false">Domains</button>
                        <button class="nav-link" id="v-pills-shipping-tab" data-bs-toggle="pill" data-bs-target="#v-pills-shipping" type="button" role="tab" aria-controls="v-pills-shipping" aria-selected="false">Shipping</button>
                        <a href="/admin/ai-config?tenant={{ selected_tenant }}" class="nav-link text-primary">
                            <i class="fas fa-external-link-alt me-1"></i> AI Configuration
                        </a>
                    </div>
                </div>
                <div class="col-md-9">
                    <form id="storeSettingsForm" method="POST">
                        <div class="tab-content" id="v-pills-tabContent">
                            <!-- Basic Settings Tab -->
                            <div class="tab-pane fade show active" id="v-pills-basic" role="tabpanel" aria-labelledby="v-pills-basic-tab">
                                <h4>Basic Store Settings</h4>
                                <div class="mb-3">
                                    <label for="store_name" class="form-label">Store Name</label>
                                    <input type="text" class="form-control" id="store_name" name="store_name">
                                </div>
                                <div class="mb-3">
                                    <label for="store_description" class="form-label">Store Description</label>
                                    <textarea class="form-control" id="store_description" name="store_description" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="contact_email" class="form-label">Contact Email</label>
                                    <input type="email" class="form-control" id="contact_email" name="contact_email">
                                </div>
                                <div class="mb-3">
                                    <label for="currency" class="form-label">Currency</label>
                                    <select class="form-select" id="currency" name="currency">
                                        <option value="USD">US Dollar (USD)</option>
                                        <option value="EUR">Euro (EUR)</option>
                                        <option value="GBP">British Pound (GBP)</option>
                                        <option value="CAD">Canadian Dollar (CAD)</option>
                                        <option value="AUD">Australian Dollar (AUD)</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Domains Tab -->
                            <div class="tab-pane fade" id="v-pills-domains" role="tabpanel" aria-labelledby="v-pills-domains-tab">
                                <h4>Domain Configuration</h4>
                                <div class="alert alert-info">
                                    <p><strong>Your store is currently accessible at:</strong></p>
                                    <p class="mb-1"><a href="https://{{ selected_tenant }}.pycommerce.com" target="_blank">https://{{ selected_tenant }}.pycommerce.com</a> (Default Subdomain)</p>
                                    <div id="customDomainDisplay" class="d-none">
                                        <p class="mt-3 mb-1"><strong>Custom Domain:</strong></p>
                                        <p><a href="https://" id="customDomainLink" target="_blank"></a></p>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="domain_type" class="form-label">Domain Type</label>
                                    <select class="form-select" id="domain_type" name="domain_type">
                                        <option value="subdomain">Subdomain (yourstore.pycommerce.com)</option>
                                        <option value="custom">Custom Domain</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3" id="custom_domain_group">
                                    <label for="custom_domain" class="form-label">Custom Domain</label>
                                    <input type="text" class="form-control" id="custom_domain" name="custom_domain" placeholder="yourdomain.com">
                                    <div class="form-text">
                                        <p>Enter your custom domain without http:// or https://</p>
                                    </div>
                                    
                                    <div class="card mt-3 border-info">
                                        <div class="card-header bg-info bg-opacity-25">
                                            <h5 class="card-title mb-0">DNS Configuration Instructions</h5>
                                        </div>
                                        <div class="card-body">
                                            <p>To point your custom domain to PyCommerce, you'll need to set up DNS records with your domain registrar:</p>
                                            <ol>
                                                <li>Log in to your domain registrar (like GoDaddy, Namecheap, etc.)</li>
                                                <li>Find the DNS settings for your domain</li>
                                                <li>Add a CNAME record that points to <code>pycommerce.com</code></li>
                                                <li>Type: <code>CNAME</code></li>
                                                <li>Host/Name: <code>@</code> or <code>www</code> (depending on if you want the root domain or www subdomain)</li>
                                                <li>Value/Points to: <code>pycommerce.com</code></li>
                                                <li>TTL: <code>3600</code> (or 1 hour)</li>
                                            </ol>
                                            <p>DNS changes typically take 24-48 hours to fully propagate across the internet.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Shipping Tab -->
                            <div class="tab-pane fade" id="v-pills-shipping" role="tabpanel" aria-labelledby="v-pills-shipping-tab">
                                <h4>Shipping Configuration</h4>
                                <div class="mb-3">
                                    <label for="store_country" class="form-label">Store Country</label>
                                    <select class="form-select" id="store_country" name="store_country">
                                        <option value="US">United States</option>
                                        <option value="CA">Canada</option>
                                        <option value="GB">United Kingdom</option>
                                        <option value="AU">Australia</option>
                                        <option value="DE">Germany</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="store_postal_code" class="form-label">Store Postal Code</label>
                                    <input type="text" class="form-control" id="store_postal_code" name="store_postal_code">
                                </div>
                                <div class="mb-3">
                                    <label for="free_shipping_threshold" class="form-label">Free Shipping Threshold</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="free_shipping_threshold" name="free_shipping_threshold" step="0.01">
                                    </div>
                                    <div class="form-text">Orders above this amount qualify for free shipping</div>
                                </div>
                                <div class="mb-3">
                                    <label for="dimensional_weight_factor" class="form-label">Dimensional Weight Factor</label>
                                    <input type="number" class="form-control" id="dimensional_weight_factor" name="dimensional_weight_factor">
                                    <div class="form-text">Factor used to calculate dimensional weight (L×W×H÷factor)</div>
                                </div>
                                <div class="mb-3">
                                    <label for="express_shipping_multiplier" class="form-label">Express Shipping Multiplier</label>
                                    <input type="number" class="form-control" id="express_shipping_multiplier" name="express_shipping_multiplier" step="0.01">
                                    <div class="form-text">Multiplier for express shipping rates (e.g., 1.75 = 75% more)</div>
                                </div>
                                <div class="mb-3">
                                    <label for="flat_rate_domestic" class="form-label">Flat Rate Domestic Shipping</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="flat_rate_domestic" name="flat_rate_domestic" step="0.01">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="flat_rate_international" class="form-label">Flat Rate International Shipping</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="flat_rate_international" name="flat_rate_international" step="0.01">
                                    </div>
                                </div>
                            </div>

                            <!-- AI Configuration has been moved to a dedicated page -->
                            <div class="d-none">
                                <!-- This section is hidden and kept for backward compatibility -->
                            </div>
                        </div>
                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary">Save Settings</button>
                            <button type="button" class="btn btn-secondary" id="resetButton">Reset</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Domain type toggle functionality
    const domainTypeSelect = document.getElementById('domain_type');
    const customDomainGroup = document.getElementById('custom_domain_group');
    const customDomainInput = document.getElementById('custom_domain');
    const customDomainDisplay = document.getElementById('customDomainDisplay');
    const customDomainLink = document.getElementById('customDomainLink');
    
    if (domainTypeSelect && customDomainGroup) {
        function toggleDomainInput() {
            if (domainTypeSelect.value === 'subdomain') {
                customDomainGroup.style.display = 'none';
                if (customDomainInput) customDomainInput.value = '';
            } else {
                customDomainGroup.style.display = 'block';
            }
        }
        
        // Initial state
        toggleDomainInput();
        
        // Event listener for changes
        domainTypeSelect.addEventListener('change', toggleDomainInput);
        
        // Custom domain display and update
        if (customDomainInput && customDomainDisplay && customDomainLink) {
            customDomainInput.addEventListener('input', function() {
                if (this.value.trim()) {
                    customDomainDisplay.classList.remove('d-none');
                    customDomainLink.textContent = 'https://' + this.value.trim();
                    customDomainLink.href = 'https://' + this.value.trim();
                } else {
                    customDomainDisplay.classList.add('d-none');
                }
            });
        }
    }
    
    // Fetch current settings
    fetch('/admin/api/store-settings')
        .then(response => response.json())
        .then(data => {
            console.log('Settings data:', data);

            // Populate form with settings data
            const settings = data.settings || {};

            // Basic Settings
            if (document.getElementById('store_name')) {
                document.getElementById('store_name').value = settings.store_name || '';
            }
            if (document.getElementById('store_description')) {
                document.getElementById('store_description').value = settings.store_description || '';
            }
            if (document.getElementById('contact_email')) {
                document.getElementById('contact_email').value = settings.contact_email || '';
            }
            if (document.getElementById('currency')) {
                document.getElementById('currency').value = settings.currency || 'USD';
            }

            // Domain Settings
            if (document.getElementById('domain_type')) {
                document.getElementById('domain_type').value = settings.domain_type || 'subdomain';
                // Trigger the toggle function manually
                const event = new Event('change');
                document.getElementById('domain_type').dispatchEvent(event);
            }
            if (document.getElementById('custom_domain')) {
                document.getElementById('custom_domain').value = settings.custom_domain || '';
                // If there's a custom domain value, show it in the display area
                if (settings.custom_domain && settings.domain_type === 'custom') {
                    const customDomainDisplay = document.getElementById('customDomainDisplay');
                    const customDomainLink = document.getElementById('customDomainLink');
                    if (customDomainDisplay && customDomainLink) {
                        customDomainDisplay.classList.remove('d-none');
                        customDomainLink.textContent = 'https://' + settings.custom_domain;
                        customDomainLink.href = 'https://' + settings.custom_domain;
                    }
                }
            }
            
            // Shipping Settings
            if (document.getElementById('store_country')) {
                document.getElementById('store_country').value = settings.store_country || 'US';
            }
            if (document.getElementById('store_postal_code')) {
                document.getElementById('store_postal_code').value = settings.store_postal_code || '';
            }
            if (document.getElementById('free_shipping_threshold')) {
                document.getElementById('free_shipping_threshold').value = settings.free_shipping_threshold || 50.00;
            }
            if (document.getElementById('dimensional_weight_factor')) {
                document.getElementById('dimensional_weight_factor').value = settings.dimensional_weight_factor || 200;
            }
            if (document.getElementById('express_shipping_multiplier')) {
                document.getElementById('express_shipping_multiplier').value = settings.express_shipping_multiplier || 1.75;
            }
            if (document.getElementById('flat_rate_domestic')) {
                document.getElementById('flat_rate_domestic').value = settings.flat_rate_domestic || settings.flat_rate_shipping || 5.99;
            }
            if (document.getElementById('flat_rate_international')) {
                document.getElementById('flat_rate_international').value = settings.flat_rate_international || 19.99;
            }

            // AI Configuration
            const aiSettings = settings.ai_settings || {};

            if (document.getElementById('openai_api_key')) {
                document.getElementById('openai_api_key').value = aiSettings.openai_api_key || '';
            }
            if (document.getElementById('openai_model')) {
                document.getElementById('openai_model').value = aiSettings.openai_model || 'gpt-3.5-turbo';
            }
            if (document.getElementById('dalle_model')) {
                document.getElementById('dalle_model').value = aiSettings.dalle_model || 'dall-e-2';
            }
            if (document.getElementById('enable_description_generation')) {
                document.getElementById('enable_description_generation').checked = aiSettings.enable_description_generation || false;
            }
            if (document.getElementById('enable_image_generation')) {
                document.getElementById('enable_image_generation').checked = aiSettings.enable_image_generation || false;
            }
            if (document.getElementById('enable_chatbot')) {
                document.getElementById('enable_chatbot').checked = aiSettings.enable_chatbot || false;
            }
        })
        .catch(error => {
            console.error('Error fetching settings:', error);
        });

    // Handle form submission
    document.getElementById('storeSettingsForm').addEventListener('submit', function(e) {
        e.preventDefault();

        // Collect form data
        const formData = new FormData(this);
        const settings = {};

        // Basic settings
        settings.store_name = formData.get('store_name');
        settings.store_description = formData.get('store_description');
        settings.contact_email = formData.get('contact_email');
        settings.currency = formData.get('currency');

        // Domain settings
        settings.domain_type = formData.get('domain_type');
        if (formData.get('domain_type') === 'custom' && formData.get('custom_domain')) {
            settings.custom_domain = formData.get('custom_domain');
        } else {
            settings.custom_domain = '';
        }
        
        // Shipping settings
        settings.store_country = formData.get('store_country');
        settings.store_postal_code = formData.get('store_postal_code');
        settings.free_shipping_threshold = parseFloat(formData.get('free_shipping_threshold') || '50.00');
        settings.dimensional_weight_factor = parseInt(formData.get('dimensional_weight_factor') || '200');
        settings.express_shipping_multiplier = parseFloat(formData.get('express_shipping_multiplier') || '1.75');
        settings.flat_rate_domestic = parseFloat(formData.get('flat_rate_domestic') || '5.99');
        settings.flat_rate_international = parseFloat(formData.get('flat_rate_international') || '19.99');

        // AI settings
        settings.ai_settings = {
            openai_api_key: formData.get('openai_api_key'),
            openai_model: formData.get('openai_model'),
            dalle_model: formData.get('dalle_model'),
            enable_description_generation: formData.get('enable_description_generation') === 'on',
            enable_image_generation: formData.get('enable_image_generation') === 'on',
            enable_chatbot: formData.get('enable_chatbot') === 'on'
        };

        // Send data to server
        fetch('/admin/api/store-settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(settings)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('Settings saved:', data);
            // Show success message
            alert('Settings saved successfully!');
        })
        .catch(error => {
            console.error('Error saving settings:', error);
            alert('Error saving settings. Please try again.');
        });
    });

    // Handle reset button
    document.getElementById('resetButton').addEventListener('click', function() {
        if (confirm('Are you sure you want to reset all settings to defaults?')) {
            fetch('/admin/api/store-settings/reset', {
                method: 'POST'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Settings reset:', data);
                // Reload the page to show default settings
                window.location.reload();
            })
            .catch(error => {
                console.error('Error resetting settings:', error);
                alert('Error resetting settings. Please try again.');
            });
        }
    });
});
</script>
{% endblock %}