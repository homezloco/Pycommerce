<!-- AI Assistant Modal -->
<div class="modal fade" id="aiAssistModal" tabindex="-1" aria-labelledby="aiAssistLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="aiAssistLabel">AI Content Assistant</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="aiAssistForm">
                    <div class="mb-3">
                        <label for="aiContentType" class="form-label">What kind of content do you need?</label>
                        <select class="form-select" id="aiContentType">
                            <option value="product_description">Product Description</option>
                            <option value="marketing_copy">Marketing Copy</option>
                            <option value="blog_post">Blog Post</option>
                            <option value="seo_content">SEO Content</option>
                            <option value="social_media">Social Media Post</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="aiPrompt" class="form-label">Describe what you want (optional):</label>
                        <textarea class="form-control" id="aiPrompt" rows="3" placeholder="Describe the product, topic, or provide specific instructions..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Content parameters:</label>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label for="aiTone" class="form-label">Tone</label>
                                <select class="form-select" id="aiTone">
                                    <option value="professional">Professional</option>
                                    <option value="casual">Casual</option>
                                    <option value="enthusiastic">Enthusiastic</option>
                                    <option value="informative">Informative</option>
                                    <option value="persuasive">Persuasive</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="aiLength" class="form-label">Length</label>
                                <select class="form-select" id="aiLength">
                                    <option value="short">Short (1-2 paragraphs)</option>
                                    <option value="medium" selected>Medium (3-4 paragraphs)</option>
                                    <option value="long">Long (5+ paragraphs)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
                <div id="aiLoadingIndicator" class="text-center py-4 d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Generating content...</p>
                </div>
                <div id="aiResult" class="border rounded p-3 bg-light d-none">
                    <h6 class="mb-3">Generated Content:</h6>
                    <div id="aiResultContent" class="generated-content"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="generateAiContent">Generate Content</button>
                <button type="button" class="btn btn-success d-none" id="useAiContent">Use This Content</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const aiForm = document.getElementById('aiAssistForm');
        const aiLoadingIndicator = document.getElementById('aiLoadingIndicator');
        const aiResult = document.getElementById('aiResult');
        const aiResultContent = document.getElementById('aiResultContent');
        const generateBtn = document.getElementById('generateAiContent');
        const useContentBtn = document.getElementById('useAiContent');

        // Handle Generate Content button click
        generateBtn.addEventListener('click', function() {
            const contentType = document.getElementById('aiContentType').value;
            const prompt = document.getElementById('aiPrompt').value;
            const tone = document.getElementById('aiTone').value;
            const length = document.getElementById('aiLength').value;

            // Show loading indicator
            aiLoadingIndicator.classList.remove('d-none');
            aiResult.classList.add('d-none');
            useContentBtn.classList.add('d-none');

            // AJAX call to backend API
            fetch('/admin/api/ai/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    content_type: contentType,
                    prompt: prompt,
                    tone: tone,
                    length: length
                }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                // Hide loading indicator
                aiLoadingIndicator.classList.add('d-none');

                // Show result
                aiResult.classList.remove('d-none');

                // Check if we have HTML content or plain text
                if (data.content) {
                    if (data.content.includes('<') && data.content.includes('>')) {
                        // It's probably HTML
                        aiResultContent.innerHTML = data.content;
                    } else {
                        // Plain text - preserve newlines
                        aiResultContent.innerHTML = data.content
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;')
                            .replace(/\n/g, '<br>');
                    }
                } else {
                    aiResultContent.innerHTML = 'No content was generated.';
                }

                // Show Use Content button
                useContentBtn.classList.remove('d-none');
            })
            .catch(error => {
                console.error('Error:', error);
                aiLoadingIndicator.classList.add('d-none');
                aiResult.classList.remove('d-none');
                aiResultContent.innerHTML = '<div class="alert alert-danger">Error generating content: ' + error.message + '</div>';
            });
        });

        // Handle Use Content button click
        useContentBtn.addEventListener('click', function() {
            const generatedContent = aiResultContent.innerHTML;
            let contentToInsert = generatedContent;

            // For plain text areas, we need to convert HTML back to text
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = generatedContent;
            const plainText = tempDiv.innerText || tempDiv.textContent;

            // Get the current editor (expecting Quill, TinyMCE, or similar)
            let inserted = false;

            try {
                if (typeof window.quill !== 'undefined' && window.quill) {
                    // For Quill
                    const range = window.quill.getSelection() || { index: window.quill.getLength(), length: 0 };
                    // If content appears to be HTML, insert as HTML, otherwise as text
                    if (generatedContent.includes('<p') || generatedContent.includes('<div') || 
                        generatedContent.includes('<h') || generatedContent.includes('<ul')) {
                        window.quill.clipboard.dangerouslyPasteHTML(range.index, generatedContent);
                    } else {
                        window.quill.insertText(range.index, plainText);
                    }
                    inserted = true;
                } else if (typeof Quill !== 'undefined') {
                    // Try to find active Quill instance
                    const quillInstances = document.querySelectorAll('.ql-editor');
                    if (quillInstances.length > 0) {
                        const quillElement = quillInstances[0];
                        const quillInstance = Quill.find(quillElement.parentNode);
                        
                        if (quillInstance) {
                            const range = quillInstance.getSelection() || { index: quillInstance.getLength(), length: 0 };
                            quillInstance.clipboard.dangerouslyPasteHTML(range.index, generatedContent);
                            inserted = true;
                        }
                    }
                }
            } catch (e) {
                console.error('Error inserting content:', e);
            }

            // Fallback if the editor isn't directly accessible
            if (!inserted) {
                // Try to find a Quill instance in the document
                const quillElements = document.querySelectorAll('.ql-editor');
                if (quillElements.length > 0) {
                    // Found a Quill editor
                    const editorElement = quillElements[0];

                    // Try to access the Quill instance via the DOM element
                    try {
                        const quillInstance = Quill.find(editorElement.parentNode);
                        if (quillInstance) {
                            const range = quillInstance.getSelection() || { index: quillInstance.getLength(), length: 0 };
                            quillInstance.clipboard.dangerouslyPasteHTML(range.index, generatedContent);
                            inserted = true;
                        }
                    } catch (e) {
                        console.warn('Could not access Quill instance:', e);
                        // Fallback to direct HTML manipulation
                        editorElement.innerHTML += generatedContent;
                        inserted = true;
                    }
                } else {
                    // Fallback - try to insert into the last focused textarea/input
                    const activeElement = document.activeElement;
                    if (activeElement && (activeElement.tagName === 'TEXTAREA' || 
                        (activeElement.tagName === 'INPUT' && activeElement.type === 'text'))) {
                        const start = activeElement.selectionStart;
                        const end = activeElement.selectionEnd;
                        const value = activeElement.value;
                        activeElement.value = value.substring(0, start) + plainText + value.substring(end);
                        inserted = true;
                    }
                }
            }

            if (!inserted) {
                // Last resort - copy to clipboard
                try {
                    navigator.clipboard.writeText(plainText).then(() => {
                        alert('Content copied to clipboard! You can now paste it where needed.');
                    }).catch(err => {
                        console.error('Could not copy text: ', err);
                        alert('Could not automatically insert content. Please copy it manually.');
                    });
                } catch (e) {
                    console.error('Clipboard API not available:', e);
                    alert('Could not automatically insert content. Please copy it manually.');
                }
            }

            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('aiAssistModal'));
            modal.hide();
        });
    });
</script>