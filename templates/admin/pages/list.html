{% extends "admin/base_admin.html" %}

{% block title %}Pages - PyCommerce Admin{% endblock %}

{% block head_extra %}
<script>
  console.log("Page builder list template loaded");
  window.addEventListener('DOMContentLoaded', (event) => {
    console.log("DOM fully loaded, checking page structure");
    console.log("Pages table exists:", document.querySelector("table") !== null);
    console.log("Tenant selected:", "{{ selected_tenant }}");
    console.log("Number of pages:", "{{ pages|length if pages else 'None' }}");
    console.log("Tenant object exists:", "{{ tenant is not none }}");
    console.log("Tenant ID:", "{{ tenant.id if tenant else 'None' }}");
    console.log("Tenant slug:", "{{ tenant.slug if tenant else 'None' }}");

    // List all pages if they exist
    {% if pages %}
      console.log("Pages list:");
      {% for page in pages %}
        console.log("  - Page: {{ page.title }} ({{ page.slug }})");
      {% endfor %}
    {% else %}
      console.log("No pages found in context");
    {% endif %}
  // Add debug button functionality
    document.addEventListener('DOMContentLoaded', function() {
      const debugBtn = document.getElementById('debugPageBuilderBtn');
      if (debugBtn) {
        debugBtn.addEventListener('click', function() {
          // Load and run the debug script
          console.log("Running page builder debug...");
          
          // Create a debug information display area if it doesn't exist
          let debugInfo = document.getElementById('pageBuilderDebugInfo');
          if (!debugInfo) {
            debugInfo = document.createElement('div');
            debugInfo.id = 'pageBuilderDebugInfo';
            debugInfo.className = 'mt-4 p-3 border bg-light';
            document.querySelector('.card-body').appendChild(debugInfo);
          }
          
          // Show loading state
          debugInfo.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Running diagnostics...</p></div>';
          
          // Fetch debug data
          fetch('/admin/debug-pages')
            .then(response => response.json())
            .then(data => {
              // Display debug information
              let html = '<h4>Page Builder Debug Information</h4>';
              html += '<div class="alert alert-info">This information helps diagnose page builder issues</div>';
              
              // Tenant information
              html += '<h5>Tenant Information</h5>';
              html += `<p>Selected tenant: ${data.selected_tenant_slug || 'None'}</p>`;
              html += `<p>Tenants count: ${data.tenants_count}</p>`;
              
              // Pages information
              html += '<h5>Pages Information</h5>';
              html += `<p>Pages count: ${data.pages_count || 0}</p>`;
              
              // Database information
              if (data.database_info) {
                html += '<h5>Database Information</h5>';
                html += '<table class="table table-sm table-bordered">';
                html += '<thead><tr><th>Table</th><th>Exists</th><th>Records</th></tr></thead><tbody>';
                
                for (const table in data.database_info.tables_exist) {
                  html += `<tr>
                    <td>${table}</td>
                    <td>${data.database_info.tables_exist[table] ? '✅' : '❌'}</td>
                    <td>${data.database_info.record_counts ? data.database_info.record_counts[table] : 'N/A'}</td>
                  </tr>`;
                }
                
                html += '</tbody></table>';
              }
              
              debugInfo.innerHTML = html;
            })
            .catch(error => {
              console.error('Error fetching debug info:', error);
              debugInfo.innerHTML = `<div class="alert alert-danger">Error fetching debug information: ${error.message}</div>`;
            });
        });
      }
    });
  });
</script>
<script src="/static/js/debug-page-builder.js"></script>
<script src="/static/js/add-debug-button.js"></script>
<script src="/static/js/force-debug-button.js"></script>

<!-- Direct debug button injection -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log("Inline script: adding debug button as a backup method");
    setTimeout(function() {
      // Check if debug button exists
      if (!document.getElementById('debugPageBuilderBtn')) {
        console.log("Inline script: debug button not found, adding now");
        
        // Find the button container
        const headerActions = document.querySelector('.card-header .d-flex.justify-content-between.align-items-center div:last-child');
        
        if (headerActions) {
          const debugBtn = document.createElement('button');
          debugBtn.id = 'debugPageBuilderBtn';
          debugBtn.className = 'btn btn-danger btn-sm ms-2';
          debugBtn.innerHTML = '<i class="fas fa-bug me-1"></i> Emergency Debug';
          
          // Add click event
          debugBtn.addEventListener('click', function() {
            window.location.href = '/admin/debug-pages';
          });
          
          headerActions.appendChild(debugBtn);
        }
      }
    }, 1000);
  });
</script>
{% endblock %}

{% block admin_content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">Pages</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="/admin">Dashboard</a></li>
        <li class="breadcrumb-item active">Pages</li>
    </ol>

    {% if status_message %}
    <div class="alert alert-{{ status_type }}" role="alert">
        {{ status_message }}
    </div>
    {% endif %}

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-bars me-1"></i>
                    Page Management
                </div>
                <div class="list-group list-group-flush">
                    <a href="/admin/pages{% if selected_tenant %}?tenant={{ selected_tenant }}{% endif %}" class="list-group-item list-group-item-action active">
                        <i class="fas fa-file-alt me-2"></i> Page List
                    </a>
                    <a href="/admin/pages/create{% if selected_tenant %}?tenant={{ selected_tenant }}{% endif %}" class="list-group-item list-group-item-action">
                        <i class="fas fa-plus me-2"></i> Create New Page
                    </a>
                    <a href="/admin/page-templates{% if selected_tenant %}?tenant={{ selected_tenant }}{% endif %}" class="list-group-item list-group-item-action">
                        <i class="fas fa-copy me-2"></i> Page Templates
                    </a>
                </div>
            </div>
        </div>
        <div class="col-md-9">
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-file-alt me-1"></i>
                            {% if tenant %}Pages for {{ tenant.name }}{% else %}Pages{% endif %}
                        </div>
                        <div>
                            <a href="/admin/pages/create{% if selected_tenant %}?tenant={{ selected_tenant }}{% endif %}" class="btn btn-primary btn-sm me-2">
                                <i class="fas fa-plus me-1"></i> Create Page
                            </a>
                            <button id="debugPageBuilderBtn" class="btn btn-secondary btn-sm">
                                <i class="fas fa-bug me-1"></i> Debug Page Builder
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    {% if not tenant %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Please select a store from the dropdown to manage pages.
                    </div>
                    {% else %}
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Slug</th>
                                    <th>Status</th>
                                    <th>Last Updated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if pages and pages|length > 0 %}
                                    {% for page in pages %}
                                    <tr>
                                        <td>{{ page.title }}</td>
                                        <td><code>{{ page.slug }}</code></td>
                                        <td>
                                            {% if page.is_published %}
                                            <span class="badge bg-success">Published</span>
                                            {% else %}
                                            <span class="badge bg-warning text-dark">Draft</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ page.updated_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <a href="/admin/pages/edit/{{ page.id }}" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-edit"></i> Edit
                                                </a>
                                                <a href="/admin/pages/preview/{{ page.id }}" target="_blank" class="btn btn-sm btn-outline-info">
                                                    <i class="fas fa-eye"></i> Preview
                                                </a>
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        data-bs-toggle="modal" data-bs-target="#deletePageModal{{ page.id }}">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </div>

                                            <!-- Delete Modal -->
                                            <div class="modal fade" id="deletePageModal{{ page.id }}" tabindex="-1" aria-labelledby="deletePageModalLabel{{ page.id }}" aria-hidden="true">
                                                <div class="modal-dialog">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title" id="deletePageModalLabel{{ page.id }}">Confirm Deletion</h5>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                        </div>
                                                        <div class="modal-body">
                                                            Are you sure you want to delete the page <strong>{{ page.title }}</strong>?
                                                            <p class="text-danger mt-3">This action cannot be undone.</p>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                            <form action="/admin/pages/delete/{{ page.id }}" method="POST">
                                                                <button type="submit" class="btn btn-danger">Delete</button>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center">No pages found. <a href="/admin/pages/create{% if selected_tenant %}?tenant={{ selected_tenant }}{% endif %}" class="btn btn-sm btn-primary">Create your first page</a>.</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock admin_content %}