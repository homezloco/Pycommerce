{% extends "admin/base_admin.html" %}

{% block title %}Edit Page - PyCommerce Admin{% endblock %}

{% block head_extra %}
<!-- Add required scripts and styles -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
<style>
  .section-container {
    border: 1px dashed #ccc;
    padding: 15px;
    margin-bottom: 20px;
    position: relative;
  }

  .section-container:hover {
    border-color: #aaa;
  }

  .section-controls {
    position: absolute;
    top: 5px;
    right: 5px;
    display: flex;
    gap: 5px;
  }

  .block-container {
    border: 1px solid #e9ecef;
    background-color: #f8f9fa;
    padding: 15px;
    margin-bottom: 15px;
    position: relative;
  }

  .block-controls {
    position: absolute;
    top: 5px;
    right: 5px;
    display: flex;
    gap: 5px;
  }

  .editor-container {
    margin-top: 10px;
  }

  .ql-editor {
    min-height: 200px;
  }

  .sortable-ghost {
    opacity: 0.4;
    border: 2px dashed #000;
  }
</style>
{% endblock %}

{% block dashboard_content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">Edit Page</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="/admin">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="/admin/pages{% if selected_tenant %}?tenant={{ selected_tenant }}{% endif %}">Pages</a></li>
        <li class="breadcrumb-item active">Edit Page</li>
    </ol>

    {% if status_message %}
    <div class="alert alert-{{ status_type }}" role="alert">
        {{ status_message }}
    </div>
    {% endif %}

    <div class="card mb-4">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-file-alt me-1"></i>
                    Editing: {{ page.title }}
                </div>
                <div>
                    <a href="/admin/pages/preview/{{ page.id }}" target="_blank" class="btn btn-info btn-sm me-2">
                        <i class="fas fa-eye me-1"></i> Preview
                    </a>
                    <a href="/admin/pages{% if selected_tenant %}?tenant={{ selected_tenant }}{% endif %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left me-1"></i> Back to Pages
                    </a>
                </div>
            </div>
        </div>
        <div class="card-body">
            <form id="editPageForm" method="POST" action="/admin/pages/update/{{ page.id }}">
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label for="title" class="form-label">Page Title</label>
                            <input type="text" class="form-control" id="title" name="title" required
                                   value="{{ page.title }}" onkeyup="generateSlug()">
                        </div>
                        <div class="mb-3">
                            <label for="slug" class="form-label">URL Slug</label>
                            <input type="text" class="form-control" id="slug" name="slug" required
                                   value="{{ page.slug }}">
                            <div class="form-text">The URL will be: /{{ tenant.slug }}/pages/<span id="slugPreview">{{ page.slug }}</span></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="mb-0">Page Settings</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="meta_title" class="form-label">Meta Title</label>
                                    <input type="text" class="form-control" id="meta_title" name="meta_title" 
                                           value="{{ page.meta_title }}" placeholder="Meta title for SEO">
                                    <div class="form-text">Leave blank to use page title</div>
                                </div>
                                <div class="mb-3">
                                    <label for="meta_description" class="form-label">Meta Description</label>
                                    <textarea class="form-control" id="meta_description" name="meta_description" 
                                              rows="3" placeholder="Meta description for SEO">{{ page.meta_description }}</textarea>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" value="true" id="is_published" name="is_published"
                                           {% if page.is_published %}checked{% endif %}>
                                    <label class="form-check-label" for="is_published">
                                        Publish page
                                    </label>
                                    <div class="form-text">If unchecked, page will be saved as a draft</div>
                                </div>
                                <input type="hidden" name="tenant_id" value="{{ tenant.id }}">
                            </div>
                        </div>
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="mb-0">Page Structure</h5>
                            </div>
                            <div class="card-body">
                                <a href="/admin/pages/editor?id={{ page.id }}{% if selected_tenant %}&tenant={{ selected_tenant }}{% endif %}" class="btn btn-primary w-100">
                                    <i class="fas fa-edit me-1"></i> Open Page Builder
                                </a>
                                <div class="mt-3 text-muted">
                                    Use the page builder to edit the layout and content of this page.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-between mt-4">
                    <a href="/admin/pages{% if selected_tenant %}?tenant={{ selected_tenant }}{% endif %}" class="btn btn-secondary">Cancel</a>
                    <button type="submit" class="btn btn-primary">Update Page</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Page Sections Preview -->
    <div class="card mb-4">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-puzzle-piece me-1"></i>
                    Page Sections
                </div>
                <div>
                    <a href="/admin/pages/editor?id={{ page.id }}{% if selected_tenant %}&tenant={{ selected_tenant }}{% endif %}" class="btn btn-primary btn-sm">
                        <i class="fas fa-edit me-1"></i> Edit Sections
                    </a>
                </div>
            </div>
        </div>
        <div class="card-body">
            {% if sections and sections|length > 0 %}
                {% for section_data in sections %}
                <div class="section-container">
                    <div class="section-header">
                        <h5>{{ section_data.section.section_type|title }} Section</h5>
                    </div>
                    <div class="blocks-container">
                        {% if section_data.blocks and section_data.blocks|length > 0 %}
                            {% for block in section_data.blocks %}
                            <div class="block-container">
                                <div class="block-header">
                                    <h6>{{ block.block_type|title }} Block</h6>
                                </div>
                                <div class="block-content">
                                    {% if block.block_type == 'text' and block.content and block.content.html %}
                                        <div class="text-muted">Text content available</div>
                                    {% elif block.block_type == 'image' and block.content and block.content.src %}
                                        <img src="{{ block.content.src }}" alt="{{ block.content.alt|default('Page image') }}" class="img-fluid" style="max-height: 100px;">
                                    {% elif block.block_type == 'video' and block.content and block.content.src %}
                                        <div class="text-muted">Video content available</div>
                                    {% else %}
                                        <div class="text-muted">No preview available</div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-muted">No blocks in this section. Use the page builder to add content.</div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    This page doesn't have any sections yet. Use the page builder to add content sections.
                </div>
                <div class="text-center my-4">
                    <a href="/admin/pages/editor?id={{ page.id }}{% if selected_tenant %}&tenant={{ selected_tenant }}{% endif %}" class="btn btn-primary">
                        <i class="fas fa-edit me-1"></i> Open Page Builder
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    function generateSlug() {
        const title = document.getElementById('title').value;
        if (!document.getElementById('slug').dataset.manuallyEdited) {
            const slug = title.toLowerCase()
                .replace(/[^\w\s-]/g, '') // Remove special chars
                .replace(/\s+/g, '-')    // Replace spaces with hyphens
                .replace(/-+/g, '-')      // Collapse multiple hyphens
                .trim();                 // Trim whitespace

            document.getElementById('slug').value = slug;
            document.getElementById('slugPreview').textContent = slug;
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Mark when user manually edits the slug
        document.getElementById('slug').addEventListener('input', function() {
            this.dataset.manuallyEdited = 'true';
            document.getElementById('slugPreview').textContent = this.value;
        });
    });
</script>
{% endblock dashboard_content %}