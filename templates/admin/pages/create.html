
{% extends "admin/base_admin.html" %}

{% block title %}Create Page - PyCommerce Admin{% endblock %}

{% block head_extra %}
<!-- TinyMCE -->
<script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
{% endblock %}

{% block admin_content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">Create Page</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="/admin">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="/admin/pages">Pages</a></li>
        <li class="breadcrumb-item active">Create Page</li>
    </ol>

    {% if status_message %}
    <div class="alert alert-{{ status_type }}" role="alert">
        {{ status_message }}
    </div>
    {% endif %}

    <div class="card mb-4">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-file-alt me-1"></i>
                    {% if tenant %}New Page for {{ tenant.name }}{% else %}New Page{% endif %}
                </div>
                <div>
                    <a href="/admin/pages{% if selected_tenant %}?tenant={{ selected_tenant }}{% endif %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left me-1"></i> Back to Pages
                    </a>
                </div>
            </div>
        </div>
        <div class="card-body">
            {% if not tenant %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Please select a store from the dropdown to create a page.
            </div>
            {% else %}
            <form id="createPageForm" method="POST" action="/admin/pages/create">
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label for="title" class="form-label">Page Title</label>
                            <input type="text" class="form-control" id="title" name="title" required
                                   placeholder="Enter page title" onkeyup="generateSlug()">
                        </div>
                        <div class="mb-3">
                            <label for="slug" class="form-label">URL Slug</label>
                            <input type="text" class="form-control" id="slug" name="slug" required
                                   placeholder="page-url-slug">
                            <div class="form-text">The URL will be: /{{ tenant.slug }}/pages/<span id="slugPreview">page-url-slug</span></div>
                        </div>
                        <div class="mb-3">
                            <label for="content" class="form-label">Page Content</label>
                            <textarea id="content" name="content" class="form-control"></textarea>
                            <div class="form-text">This content will be placed in the main content section of your page</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="mb-0">Page Settings</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="template_id" class="form-label">Page Template</label>
                                    <select class="form-select" id="template_id" name="template_id">
                                        <option value="">None (Blank Page)</option>
                                        {% for template in templates %}
                                        <option value="{{ template.id }}" {% if template_id == template.id %}selected{% endif %}>
                                            {{ template.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <div class="form-text">Starting point for your page layout</div>
                                </div>
                                <div class="mb-3">
                                    <label for="meta_title" class="form-label">Meta Title</label>
                                    <input type="text" class="form-control" id="meta_title" name="meta_title" 
                                           placeholder="Meta title for SEO (optional)">
                                    <div class="form-text">Leave blank to use page title</div>
                                </div>
                                <div class="mb-3">
                                    <label for="meta_description" class="form-label">Meta Description</label>
                                    <textarea class="form-control" id="meta_description" name="meta_description" 
                                              rows="3" placeholder="Meta description for SEO (optional)"></textarea>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" value="true" id="is_published" name="is_published">
                                    <label class="form-check-label" for="is_published">
                                        Publish page immediately
                                    </label>
                                    <div class="form-text">If unchecked, page will be saved as a draft</div>
                                </div>
                                <input type="hidden" name="tenant_id" value="{{ tenant.id }}">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-secondary" onclick="history.back()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Page</button>
                </div>
            </form>
            {% endif %}
        </div>
    </div>
</div>

<script>
    function generateSlug() {
        const title = document.getElementById('title').value;
        const slug = title.toLowerCase()
            .replace(/[^\w\s-]/g, '') // Remove special chars
            .replace(/\s+/g, '-')    // Replace spaces with hyphens
            .replace(/-+/g, '-')      // Collapse multiple hyphens
            .trim();                 // Trim whitespace
        
        document.getElementById('slug').value = slug;
        document.getElementById('slugPreview').textContent = slug;
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize TinyMCE
        const editorConfig = {{ editor_config|safe }};
        
        tinymce.init({
            selector: '#content',
            height: 500,
            menubar: true,
            plugins: [
                'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
                'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                'insertdatetime', 'media', 'table', 'help', 'wordcount'
            ],
            toolbar: 'undo redo | formatselect | ' +
                'bold italic backcolor | alignleft aligncenter ' +
                'alignright alignjustify | bullist numlist outdent indent | ' +
                'removeformat | image media link | help',
            content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; font-size: 14px; }',
            // Add file picker for media manager
            file_picker_callback: function(callback, value, meta) {
                // Open media selector modal
                openMediaSelector(function(id, url, name) {
                    // When a file is selected, handle different types
                    if (meta.filetype === 'image') {
                        callback(url, { title: name });
                    } else if (meta.filetype === 'media') {
                        callback(url, { title: name });
                    } else {
                        callback(url, { title: name });
                    }
                });
            }
        });
    });
    
    // Function to open the media selector modal
    function openMediaSelector(callback) {
        // Store the callback function for later use
        window.mediaSelectionCallback = callback;
        
        // Show the media selector modal
        const mediaSelectorModal = new bootstrap.Modal(document.getElementById('mediaSelectorModal'));
        mediaSelectorModal.show();
        
        // Load media items
        loadMediaItems();
    }
    
    // Function to load media items from the API
    function loadMediaItems() {
        const mediaGrid = document.getElementById('mediaSelectorGrid');
        
        // Show loading indicator
        mediaGrid.innerHTML = `
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading media...</p>
            </div>`;
        
        // Get filter values
        const searchTerm = document.getElementById('searchMedia')?.value || '';
        const mediaType = document.getElementById('filterMediaType')?.value || 'image';
        
        // Fetch media items from the API
        fetch(`/admin/api/media?search=${encodeURIComponent(searchTerm)}&type=${encodeURIComponent(mediaType)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data && data.items && data.items.length > 0) {
                    let html = '';
                    data.items.forEach(item => {
                        // Determine preview image
                        let previewSrc = item.url;
                        if (item.file_type.startsWith('image/svg')) {
                            previewSrc = item.url;
                        } else if (item.thumbnail_url) {
                            previewSrc = item.thumbnail_url;
                        }
                        
                        html += `
                            <div class="col">
                                <div class="card h-100">
                                    <div class="card-img-wrapper" style="height: 160px; display: flex; align-items: center; justify-content: center; background-color: #f8f9fa;">
                                        <img src="${previewSrc}" class="card-img-top" alt="${item.filename}" 
                                             style="max-height: 100%; max-width: 100%; object-fit: contain;">
                                    </div>
                                    <div class="card-body">
                                        <h6 class="card-title text-truncate">${item.filename || 'Unnamed file'}</h6>
                                        <button class="btn btn-sm btn-primary w-100" 
                                                onclick="selectMedia('${item.id}', '${item.url}', '${item.filename}')">
                                            Select
                                        </button>
                                    </div>
                                </div>
                            </div>`;
                    });

                    mediaGrid.innerHTML = html;
                } else {
                    mediaGrid.innerHTML = '<div class="col-12 text-center py-5"><p>No media found. Please upload some images first.</p></div>';
                }
            })
            .catch(error => {
                console.error('Error loading media:', error);
                mediaGrid.innerHTML = '<div class="col-12 text-center py-5"><p>Error loading media. Please try again later.</p></div>';
            });
    }
    
    // Function to handle media selection
    function selectMedia(id, url, name) {
        if (window.mediaSelectionCallback) {
            window.mediaSelectionCallback(id, url, name);
            
            // Close the modal
            const mediaSelectorModal = bootstrap.Modal.getInstance(document.getElementById('mediaSelectorModal'));
            if (mediaSelectorModal) {
                mediaSelectorModal.hide();
            }
        }
    }
</script>

<!-- Media Selector Modal -->
<div class="modal fade" id="mediaSelectorModal" tabindex="-1" aria-labelledby="mediaSelectorLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mediaSelectorLabel">Select Media</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" id="searchMedia" placeholder="Search media...">
                            <button class="btn btn-outline-secondary" type="button" id="searchMediaBtn" onclick="loadMediaItems()">Search</button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterMediaType" onchange="loadMediaItems()">
                            <option value="">All Types</option>
                            <option value="image" selected>Images</option>
                            <option value="video">Videos</option>
                            <option value="audio">Audio</option>
                            <option value="application">Documents</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <div class="d-grid">
                            <button class="btn btn-primary" type="button" onclick="window.location.href='/admin/media'">
                                <i class="fas fa-photo-video me-1"></i> Manage Media
                            </button>
                        </div>
                    </div>
                </div>
                <div id="mediaSelectorGrid" class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3">
                    <!-- Media items will be loaded here via JavaScript -->
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading media...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock admin_content %}
