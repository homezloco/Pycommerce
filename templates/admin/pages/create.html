{% extends "admin/base_admin.html" %}

{% block title %}Create Page - PyCommerce Admin{% endblock %}

{% block head_extra %}
<!-- Quill Editor -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<!-- Quill Debug Utilities -->
<script src="/static/js/quill-debug-utility.js"></script>
<script src="/static/js/debug-page-builder.js"></script>
<script src="/static/js/debug-quill-editor.js"></script>
<script>
    // Register diagnostic function for easy access from console
    window.debugPageEditor = function() {
        console.log("Running comprehensive page editor diagnostics...");
        if (typeof PyCommerceQuillDebug !== 'undefined') {
            PyCommerceQuillDebug.diagnose();
        }
        if (typeof window.debugPageBuilderEditor === 'function') {
            window.debugPageBuilderEditor();
        }
    };
</script>
{% endblock %}

{% block dashboard_content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">Create Page</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="/admin">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="/admin/pages">Pages</a></li>
        <li class="breadcrumb-item active">Create Page</li>
    </ol>

    {% if status_message %}
    <div class="alert alert-{{ status_type }}" role="alert">
        {{ status_message }}
    </div>
    {% endif %}

    <div class="card mb-4">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-file-alt me-1"></i>
                    {% if tenant %}New Page for {{ tenant.name }}{% else %}New Page{% endif %}
                </div>
                <div>
                    <a href="/admin/pages{% if selected_tenant %}?tenant={{ selected_tenant }}{% endif %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left me-1"></i> Back to Pages
                    </a>
                </div>
            </div>
        </div>
        <div class="card-body">
            {% if not tenant %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Please select a store from the dropdown to create a page.
            </div>
            {% else %}
            <form id="createPageForm" method="POST" action="/admin/pages/create-with-template">
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label for="title" class="form-label">Page Title</label>
                            <input type="text" class="form-control" id="title" name="title" required
                                   placeholder="Enter page title" onkeyup="generateSlug()">
                        </div>
                        <div class="mb-3">
                            <label for="slug" class="form-label">URL Slug</label>
                            <input type="text" class="form-control" id="slug" name="slug" required
                                   placeholder="page-url-slug">
                            <div class="form-text">The URL will be: /{{ tenant.slug }}/pages/<span id="slugPreview">page-url-slug</span></div>
                        </div>
                        <div class="mb-3">
                            <label for="content" class="form-label">Page Content</label>
                            <textarea id="content" name="content" class="form-control"></textarea>
                            <div class="form-text">This content will be placed in the main content section of your page</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="mb-0">Page Settings</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="template_id" class="form-label">Page Template</label>
                                    <select class="form-select" id="template_id" name="template_id">
                                        <option value="">None (Blank Page)</option>
                                        {% for template in templates %}
                                        <option value="{{ template.id }}" {% if template_id == template.id %}selected{% endif %}>
                                            {{ template.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <div class="form-text">Starting point for your page layout</div>
                                </div>
                                <div class="mb-3">
                                    <label for="meta_title" class="form-label">Meta Title</label>
                                    <input type="text" class="form-control" id="meta_title" name="meta_title" 
                                           placeholder="Meta title for SEO (optional)">
                                    <div class="form-text">Leave blank to use page title</div>
                                </div>
                                <div class="mb-3">
                                    <label for="meta_description" class="form-label">Meta Description</label>
                                    <textarea class="form-control" id="meta_description" name="meta_description" 
                                              rows="3" placeholder="Meta description for SEO (optional)"></textarea>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" value="true" id="is_published" name="is_published">
                                    <label class="form-check-label" for="is_published">
                                        Publish page immediately
                                    </label>
                                    <div class="form-text">If unchecked, page will be saved as a draft</div>
                                </div>
                                <input type="hidden" name="tenant_id" value="{{ tenant.id }}">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-secondary" onclick="history.back()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Page</button>
                </div>
            </form>
            {% endif %}
        </div>
    </div>
</div>

<script>
    function generateSlug() {
        const title = document.getElementById('title').value;
        const slug = title.toLowerCase()
            .replace(/[^\w\s-]/g, '') // Remove special chars
            .replace(/\s+/g, '-')    // Replace spaces with hyphens
            .replace(/-+/g, '-')      // Collapse multiple hyphens
            .trim();                 // Trim whitespace

        document.getElementById('slug').value = slug;
        document.getElementById('slugPreview').textContent = slug;
    }

    // Track script loading state
    const scriptLoadState = {
        quill: false,
        quillDebug: false,
        quillIntegration: false
    };

    // Function to check if all scripts are loaded
    function checkAllScriptsLoaded() {
        if (scriptLoadState.quill && scriptLoadState.quillDebug && scriptLoadState.quillIntegration) {
            console.log("✅ All scripts loaded successfully, initializing editor...");
            initWithPyCommerce();
            return true;
        }
        return false;
    }

    // Load the required scripts in parallel but initialize in the right order
    function loadEditorScripts() {
        // Check if Quill is already loaded
        if (typeof Quill !== 'undefined') {
            console.log("Quill already loaded");
            scriptLoadState.quill = true;
        } else {
            console.log("Loading Quill dynamically...");
            
            // Load Quill CSS
            const quillCSS = document.createElement('link');
            quillCSS.rel = 'stylesheet';
            quillCSS.href = 'https://cdn.quilljs.com/1.3.6/quill.snow.css';
            document.head.appendChild(quillCSS);
            
            // Load Quill JS
            const quillScript = document.createElement('script');
            quillScript.src = 'https://cdn.quilljs.com/1.3.6/quill.min.js';
            quillScript.onload = function() {
                console.log("✅ Quill loaded");
                scriptLoadState.quill = true;
                checkAllScriptsLoaded();
            };
            quillScript.onerror = function(e) {
                console.error("❌ Failed to load Quill:", e);
                fallbackToDirectInitialization();
            };
            document.head.appendChild(quillScript);
        }
        
        // Check if debug utility is already loaded
        if (typeof PyCommerceQuillDebug !== 'undefined') {
            console.log("Quill debug utility already loaded");
            scriptLoadState.quillDebug = true;
        } else {
            console.log("Loading Quill debugging utility...");
            const debugScript = document.createElement('script');
            debugScript.src = '/static/js/quill-debug-utility.js';
            debugScript.onload = function() {
                console.log("✅ Debug utility loaded");
                scriptLoadState.quillDebug = true;
                checkAllScriptsLoaded();
            };
            debugScript.onerror = function(e) {
                console.error("❌ Failed to load debug utility:", e);
                scriptLoadState.quillDebug = true; // Mark as loaded anyway to continue
                checkAllScriptsLoaded();
            };
            document.head.appendChild(debugScript);
        }
        
        // Check if PyCommerceQuill is already loaded
        if (typeof PyCommerceQuill !== 'undefined') {
            console.log("PyCommerceQuill integration already loaded");
            scriptLoadState.quillIntegration = true;
        } else {
            console.log("Loading PyCommerceQuill integration...");
            const integrationScript = document.createElement('script');
            integrationScript.src = '/static/js/quill-integration.js';
            integrationScript.onload = function() {
                console.log("✅ PyCommerceQuill loaded");
                scriptLoadState.quillIntegration = true;
                checkAllScriptsLoaded();
            };
            integrationScript.onerror = function(e) {
                console.error("❌ Failed to load PyCommerceQuill integration:", e);
                fallbackToDirectInitialization();
            };
            document.head.appendChild(integrationScript);
        }
        
        // Set a timeout to check if all scripts loaded
        setTimeout(function() {
            if (!checkAllScriptsLoaded()) {
                console.warn("⚠️ Not all scripts loaded after timeout, attempting initialization anyway");
                // Try to initialize with whatever we have
                if (typeof Quill !== 'undefined') {
                    if (typeof PyCommerceQuill !== 'undefined' && PyCommerceQuill.init) {
                        initWithPyCommerce();
                    } else {
                        fallbackToDirectInitialization();
                    }
                } else {
                    console.error("❌ Quill not loaded, cannot initialize editor");
                }
            }
        }, 3000);
    }
    
    // Initialize with PyCommerceQuill
    function initWithPyCommerce() {
        // Use a properly parsed editor config object with defaults if parsing fails
        let editorConfig = {};
        try {
            editorConfig = JSON.parse('{{ editor_config|safe }}');
        } catch (e) {
            console.error("Error parsing editor config:", e);
            // Use default config
            editorConfig = {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline', 'strike'],
                        [{'header': 1}, {'header': 2}],
                        [{'list': 'ordered'}, {'list': 'bullet'}],
                        [{'indent': '-1'}, {'indent': '+1'}],
                        [{'align': []}],
                        ['link', 'image'],
                        ['clean']
                    ]
                }
            };
        }
        
        if (window.PyCommerceQuill && PyCommerceQuill.init) {
            console.log("Initializing Quill editor with PyCommerceQuill integration");
            
            PyCommerceQuill.init({
                targetSelector: '#content',
                formSelector: '#createPageForm',
                containerId: 'quill-editor-container',
                modalId: 'aiAssistModal',
                height: '500px',
                options: editorConfig || {},
                debug: true
            });
            
            console.log("✅ Editor initialization requested");
        } else {
            console.error("❌ PyCommerceQuill integration not available");
            fallbackToDirectInitialization();
        }
    }
    
    // Fallback to direct Quill initialization without PyCommerceQuill
    function fallbackToDirectInitialization() {
        console.log("Falling back to direct Quill initialization");
        
        // Only proceed if Quill is available
        if (typeof Quill === 'undefined') {
            console.error("❌ Cannot fall back - Quill is not available");
            return;
        }
        
        const contentTextarea = document.getElementById('content');
        if (contentTextarea) {
            console.log("Creating container for direct Quill initialization");
            
            // Create container for Quill if it doesn't exist
            let container = document.getElementById('quill-editor-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'quill-editor-container';
                container.style.height = '500px';
                container.style.marginBottom = '20px';
                
                // Hide the textarea
                contentTextarea.style.display = 'none';
                
                // Insert container before textarea
                contentTextarea.parentNode.insertBefore(container, contentTextarea);
            }
            
            // Initialize Quill directly
            const quill = new Quill('#quill-editor-container', {
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline', 'strike'],
                        ['blockquote', 'code-block'],
                        [{ 'header': 1 }, { 'header': 2 }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'indent': '-1'}, { 'indent': '+1' }],
                        [{ 'size': ['small', false, 'large', 'huge'] }],
                        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'align': [] }],
                        ['clean'],
                        ['link', 'image']
                    ]
                },
                theme: 'snow'
            });
            
            // Add submit handler to form
            const form = document.getElementById('createPageForm');
            if (form) {
                form.addEventListener('submit', function() {
                    contentTextarea.value = quill.root.innerHTML;
                });
            }
            
            console.log("✅ Direct Quill initialization complete");
        } else {
            console.error("❌ Content textarea not found");
        }
    }
    
    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        // Check if quill-integration.js is already loaded
        if (typeof PyCommerceQuill !== 'undefined') {
            console.log("PyCommerceQuill is already loaded, using existing integration");
            
            // Initialize with existing PyCommerceQuill
            // Use a properly parsed editor config object with defaults if parsing fails
            let editorConfig = {};
            try {
                editorConfig = JSON.parse('{{ editor_config|safe }}');
            } catch (e) {
                console.error("Error parsing editor config:", e);
                // Use default config
                editorConfig = {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            ['bold', 'italic', 'underline', 'strike'],
                            [{'header': 1}, {'header': 2}],
                            [{'list': 'ordered'}, {'list': 'bullet'}],
                            [{'indent': '-1'}, {'indent': '+1'}],
                            [{'align': []}],
                            ['link', 'image'],
                            ['clean']
                        ]
                    }
                };
            }
            
            // Only initialize if there's no Quill editor already
            if (document.querySelectorAll('.ql-container').length === 0) {
                PyCommerceQuill.init({
                    targetSelector: '#content',
                    formSelector: '#createPageForm',
                    containerId: 'quill-editor-container',
                    modalId: 'aiAssistModal',
                    height: '500px',
                    options: editorConfig || {},
                    debug: true
                });
            } else {
                console.log("Quill editor already exists, skipping initialization");
            }
        } else {
            // Load scripts if PyCommerceQuill is not available
            console.log("PyCommerceQuill not loaded, loading scripts first");
            loadEditorScripts();
        }
        
        // Add a manual retry button (hidden by default, shown if initialization fails)
        setTimeout(function() {
            if (document.querySelectorAll('.ql-container').length === 0) {
                console.warn("⚠️ No Quill containers found after timeout, adding retry button");
                
                const contentArea = document.querySelector('#content');
                if (contentArea && contentArea.parentNode) {
                    // Check if retry button already exists
                    if (!document.querySelector('.quill-retry-button')) {
                        const retryButton = document.createElement('button');
                        retryButton.type = 'button';
                        retryButton.className = 'btn btn-warning mt-2 mb-3 quill-retry-button';
                        retryButton.innerHTML = '<i class="fas fa-sync"></i> Retry Editor Initialization';
                        retryButton.onclick = function() {
                            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Initializing...';
                            // Use PyCommerceQuill if available, otherwise load scripts
                            if (typeof PyCommerceQuill !== 'undefined') {
                                // Use a properly parsed editor config object with defaults if parsing fails
                                let editorConfig = {};
                                try {
                                    editorConfig = JSON.parse('{{ editor_config|safe }}');
                                } catch (e) {
                                    console.error("Error parsing editor config:", e);
                                    // Use default config
                                    editorConfig = {
                                        theme: 'snow',
                                        modules: {
                                            toolbar: [
                                                ['bold', 'italic', 'underline', 'strike'],
                                                [{'header': 1}, {'header': 2}],
                                                [{'list': 'ordered'}, {'list': 'bullet'}],
                                                [{'indent': '-1'}, {'indent': '+1'}],
                                                [{'align': []}],
                                                ['link', 'image'],
                                                ['clean']
                                            ]
                                        }
                                    };
                                }
                                PyCommerceQuill.init({
                                    targetSelector: '#content',
                                    formSelector: '#createPageForm',
                                    containerId: 'quill-editor-container',
                                    modalId: 'aiAssistModal',
                                    height: '500px',
                                    options: editorConfig || {},
                                    debug: true
                                });
                            } else {
                                loadEditorScripts();
                            }
                            
                            setTimeout(() => {
                                if (document.querySelectorAll('.ql-container').length > 0) {
                                    this.remove();
                                } else {
                                    this.innerHTML = '<i class="fas fa-sync"></i> Retry Editor Initialization';
                                }
                            }, 3000);
                        };
                    
                    contentArea.parentNode.insertBefore(retryButton, contentArea);
                }
            }
        }, 5000);
    });

    // Function to open the media selector modal
    function openMediaSelector(callback) {
        // Store the callback function for later use
        window.mediaSelectionCallback = callback;

        // Show the media selector modal
        const mediaSelectorModal = new bootstrap.Modal(document.getElementById('mediaSelectorModal'));
        mediaSelectorModal.show();

        // Load media items
        loadMediaItems();
    }

    // Function to load media items from the API
    function loadMediaItems() {
        const mediaGrid = document.getElementById('mediaSelectorGrid');

        // Show loading indicator
        mediaGrid.innerHTML = `
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading media...</p>
            </div>`;

        // Get filter values
        const searchTerm = document.getElementById('searchMedia')?.value || '';
        const mediaType = document.getElementById('filterMediaType')?.value || 'image';

        // Fetch media items from the API
        fetch(`/admin/api/media?search=${encodeURIComponent(searchTerm)}&type=${encodeURIComponent(mediaType)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data && data.items && data.items.length > 0) {
                    let html = '';
                    data.items.forEach(item => {
                        // Determine preview image
                        let previewSrc = item.url;
                        if (item.file_type.startsWith('image/svg')) {
                            previewSrc = item.url;
                        } else if (item.thumbnail_url) {
                            previewSrc = item.thumbnail_url;
                        }

                        html += `
                            <div class="col">
                                <div class="card h-100">
                                    <div class="card-img-wrapper" style="height: 160px; display: flex; align-items: center; justify-content: center; background-color: #f8f9fa;">
                                        <img src="${previewSrc}" class="card-img-top" alt="${item.filename}" 
                                             style="max-height: 100%; max-width: 100%; object-fit: contain;">
                                    </div>
                                    <div class="card-body">
                                        <h6 class="card-title text-truncate">${item.filename || 'Unnamed file'}</h6>
                                        <button class="btn btn-sm btn-primary w-100" 
                                                onclick="selectMedia('${item.id}', '${item.url}', '${item.filename}')">
                                            Select
                                        </button>
                                    </div>
                                </div>
                            </div>`;
                    });

                    mediaGrid.innerHTML = html;
                } else {
                    mediaGrid.innerHTML = '<div class="col-12 text-center py-5"><p>No media found. Please upload some images first.</p></div>';
                }
            })
            .catch(error => {
                console.error('Error loading media:', error);
                mediaGrid.innerHTML = '<div class="col-12 text-center py-5"><p>Error loading media. Please try again later.</p></div>';
            });
    }

    // Function to handle media selection
    function selectMedia(id, url, name) {
        if (window.mediaSelectionCallback) {
            window.mediaSelectionCallback(id, url, name);

            // Close the modal
            const mediaSelectorModal = bootstrap.Modal.getInstance(document.getElementById('mediaSelectorModal'));
            if (mediaSelectorModal) {
                mediaSelectorModal.hide();
            }
        }
    }
</script>

<!-- Media Selector Modal -->
<div class="modal fade" id="mediaSelectorModal" tabindex="-1" aria-labelledby="mediaSelectorLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mediaSelectorLabel">Select Media</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" id="searchMedia" placeholder="Search media...">
                            <button class="btn btn-outline-secondary" type="button" id="searchMediaBtn" onclick="loadMediaItems()">Search</button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterMediaType" onchange="loadMediaItems()">
                            <option value="">All Types</option>
                            <option value="image" selected>Images</option>
                            <option value="video">Videos</option>
                            <option value="audio">Audio</option>
                            <option value="application">Documents</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <div class="d-grid">
                            <button class="btn btn-primary" type="button" onclick="window.location.href='/admin/media'">
                                <i class="fas fa-photo-video me-1"></i> Manage Media
                            </button>
                        </div>
                    </div>
                </div>
                <div id="mediaSelectorGrid" class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3">
                    <!-- Media items will be loaded here via JavaScript -->
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading media...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% include "admin/partials/ai_modal.html" %}
{% endblock dashboard_content %}