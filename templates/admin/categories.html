{% extends "admin/base_admin.html" %}

{% block title %}Categories Management - {{ tenant.name }}{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">Categories</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="/admin/dashboard?tenant={{ tenant.slug }}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="/admin/categories?tenant={{ tenant.slug }}">Categories</a></li>
        {% for breadcrumb in parent_breadcrumbs %}
        <li class="breadcrumb-item">
            <a href="/admin/categories?tenant={{ tenant.slug }}&parent_id={{ breadcrumb.id }}">
                {{ breadcrumb.name }}
            </a>
        </li>
        {% endfor %}
    </ol>

    {% if error %}
    <div class="alert alert-danger" role="alert">
        {{ error }}
    </div>
    {% endif %}

    {% if success %}
    <div class="alert alert-success" role="alert">
        {{ success }}
    </div>
    {% endif %}

    <div class="row">
        <div class="col-xl-6">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-folder me-1"></i>
                    {% if parent_category %}
                    Subcategories of {{ parent_category.name }}
                    {% else %}
                    Root Categories
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if categories %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Slug</th>
                                    <th>Products</th>
                                    <th>Subcategories</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for category in categories %}
                                <tr>
                                    <td>
                                        <a href="/admin/categories?tenant={{ tenant.slug }}&parent_id={{ category.id }}">
                                            {{ category.name }}
                                        </a>
                                    </td>
                                    <td>{{ category.slug }}</td>
                                    <td>{{ category.product_count }}</td>
                                    <td>{{ category.subcategory_count }}</td>
                                    <td>
                                        {% if category.active %}
                                        <span class="badge bg-success">Active</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-primary" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#editCategoryModal"
                                                data-id="{{ category.id }}"
                                                data-name="{{ category.name }}"
                                                data-slug="{{ category.slug }}"
                                                data-description="{{ category.description or '' }}"
                                                data-parent="{{ category.parent_id or '' }}"
                                                data-active="{{ 'checked' if category.active else '' }}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        
                                        <button type="button" class="btn btn-sm btn-danger" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#deleteCategoryModal"
                                                data-id="{{ category.id }}"
                                                data-name="{{ category.name }}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        No categories found. Create your first category using the form on the right.
                    </div>
                    {% endif %}

                    {% if parent_category %}
                    <a href="/admin/categories?tenant={{ tenant.slug }}{% if parent_category.parent_id %}&parent_id={{ parent_category.parent_id }}{% endif %}" 
                       class="btn btn-secondary mt-3">
                        <i class="fas fa-arrow-left"></i> Back to {{ parent_category.parent_id|default('Root Categories', true) }}
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-xl-6">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-plus-circle me-1"></i>
                    {% if parent_category %}
                    Add Subcategory to {{ parent_category.name }}
                    {% else %}
                    Add New Category
                    {% endif %}
                </div>
                <div class="card-body">
                    <form action="/admin/categories/create" method="post">
                        <input type="hidden" name="tenant" value="{{ tenant.slug }}">
                        
                        {% if parent_category %}
                        <input type="hidden" name="parent_id" value="{{ parent_category.id }}">
                        {% else %}
                        <div class="mb-3">
                            <label for="parent_id" class="form-label">Parent Category (Optional)</label>
                            <select class="form-select" id="parent_id" name="parent_id">
                                <option value="">None (Root Category)</option>
                                {% for cat in categories %}
                                <option value="{{ cat.id }}">{{ cat.name }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">If selected, this will become a subcategory of the parent.</div>
                        </div>
                        {% endif %}
                        
                        <div class="mb-3">
                            <label for="name" class="form-label">Category Name</label>
                            <input type="text" class="form-control" id="name" name="name" required 
                                   onkeyup="document.getElementById('slug').value = this.value.toLowerCase().replace(/[^a-z0-9]+/g, '-')">
                        </div>
                        
                        <div class="mb-3">
                            <label for="slug" class="form-label">Slug</label>
                            <input type="text" class="form-control" id="slug" name="slug" required 
                                   pattern="[a-z0-9\-]+" title="Lowercase letters, numbers, and hyphens only">
                            <div class="form-text">Used in URLs. Only lowercase letters, numbers, and hyphens.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Description (Optional)</label>
                            <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                        </div>
                        
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="active" name="active" checked>
                            <label class="form-check-label" for="active">Active</label>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Create Category</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" aria-labelledby="editCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCategoryModalLabel">Edit Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editCategoryForm" method="post">
                <div class="modal-body">
                    <input type="hidden" name="tenant" value="{{ tenant.slug }}">
                    
                    <div class="mb-3">
                        <label for="edit_name" class="form-label">Category Name</label>
                        <input type="text" class="form-control" id="edit_name" name="name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_slug" class="form-label">Slug</label>
                        <input type="text" class="form-control" id="edit_slug" name="slug" required 
                               pattern="[a-z0-9\-]+" title="Lowercase letters, numbers, and hyphens only">
                        <div class="form-text">Used in URLs. Only lowercase letters, numbers, and hyphens.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_description" class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="edit_description" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_parent_id" class="form-label">Parent Category (Optional)</label>
                        <select class="form-select" id="edit_parent_id" name="parent_id">
                            <option value="">None (Root Category)</option>
                            {% for cat in categories %}
                            <option value="{{ cat.id }}">{{ cat.name }}</option>
                            {% endfor %}
                            {% if parent_category %}
                            <option value="{{ parent_category.id }}">{{ parent_category.name }}</option>
                            {% endif %}
                        </select>
                        <div class="form-text">Warning: Changing parent can affect category hierarchy.</div>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="edit_active" name="active">
                        <label class="form-check-label" for="edit_active">Active</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Category Modal -->
<div class="modal fade" id="deleteCategoryModal" tabindex="-1" aria-labelledby="deleteCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteCategoryModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the category <strong id="deleteCategoryName"></strong>?</p>
                <p class="text-danger">This action cannot be undone. Categories with subcategories cannot be deleted.</p>
            </div>
            <form id="deleteCategoryForm" method="post">
                <input type="hidden" name="tenant" value="{{ tenant.slug }}">
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete Category</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get error/success from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const error = urlParams.get('error');
        const success = urlParams.get('success');
        
        // Display error/success messages if present
        if (error) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = error + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
            document.querySelector('.breadcrumb').insertAdjacentElement('afterend', alertDiv);
        }
        
        if (success) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = success + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
            document.querySelector('.breadcrumb').insertAdjacentElement('afterend', alertDiv);
        }
        
        // Edit category modal
        const editCategoryModal = document.getElementById('editCategoryModal');
        if (editCategoryModal) {
            editCategoryModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const categoryId = button.getAttribute('data-id');
                const categoryName = button.getAttribute('data-name');
                const categorySlug = button.getAttribute('data-slug');
                const categoryDescription = button.getAttribute('data-description');
                const categoryParent = button.getAttribute('data-parent');
                const categoryActive = button.getAttribute('data-active');
                
                // Update form action
                const form = document.getElementById('editCategoryForm');
                form.action = `/admin/categories/${categoryId}/update`;
                
                // Populate form fields
                document.getElementById('edit_name').value = categoryName;
                document.getElementById('edit_slug').value = categorySlug;
                document.getElementById('edit_description').value = categoryDescription;
                
                // Set parent category if exists
                const parentSelect = document.getElementById('edit_parent_id');
                if (parentSelect) {
                    if (categoryParent) {
                        parentSelect.value = categoryParent;
                    } else {
                        parentSelect.value = '';
                    }
                    
                    // Disable selecting self as parent
                    for (let i = 0; i < parentSelect.options.length; i++) {
                        if (parentSelect.options[i].value === categoryId) {
                            parentSelect.options[i].disabled = true;
                        } else {
                            parentSelect.options[i].disabled = false;
                        }
                    }
                }
                
                // Set active status
                document.getElementById('edit_active').checked = categoryActive === 'checked';
            });
        }
        
        // Delete category modal
        const deleteCategoryModal = document.getElementById('deleteCategoryModal');
        if (deleteCategoryModal) {
            deleteCategoryModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const categoryId = button.getAttribute('data-id');
                const categoryName = button.getAttribute('data-name');
                
                // Update form action
                const form = document.getElementById('deleteCategoryForm');
                form.action = `/admin/categories/${categoryId}/delete`;
                
                // Update confirmation message
                document.getElementById('deleteCategoryName').textContent = categoryName;
            });
        }
        
        // Auto-generate slug from name for new categories
        const nameInput = document.getElementById('name');
        const slugInput = document.getElementById('slug');
        if (nameInput && slugInput) {
            nameInput.addEventListener('input', function() {
                // Only auto-update if the slug hasn't been manually edited
                if (!slugInput.dataset.manuallyEdited) {
                    slugInput.value = this.value.toLowerCase()
                        .replace(/[^a-z0-9]+/g, '-')
                        .replace(/^-+|-+$/g, '');
                }
            });
            
            // Track if slug has been manually edited
            slugInput.addEventListener('input', function() {
                this.dataset.manuallyEdited = true;
            });
        }
    });
</script>
{% endblock %}