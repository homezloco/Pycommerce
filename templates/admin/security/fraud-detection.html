{% extends "admin/base.html" %}

{% block title %}Fraud Detection - PyCommerce Admin{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
        <h1 class="h2"><i class="bi bi-shield-lock me-2"></i>Fraud Detection Settings</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <a href="/admin/security" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i> Back to Security
                </a>
                <button type="button" class="btn btn-sm btn-outline-primary" id="refresh-security">
                    <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                </button>
                <button type="button" class="btn btn-sm btn-primary" id="save-fraud-settings">
                    <i class="bi bi-save me-1"></i> Save Settings
                </button>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary bg-gradient text-white shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">Fraud Score</h6>
                            <h4 class="mb-0">Low Risk</h4>
                        </div>
                        <div>
                            <i class="bi bi-shield-check display-6 opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success bg-gradient text-white shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">Blocked Transactions</h6>
                            <h4 class="mb-0">12 (Last 30 days)</h4>
                        </div>
                        <div>
                            <i class="bi bi-x-octagon display-6 opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning bg-gradient text-white shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">Flagged for Review</h6>
                            <h4 class="mb-0">3 Pending</h4>
                        </div>
                        <div>
                            <i class="bi bi-flag display-6 opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info bg-gradient text-white shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">Risk Detection Rate</h6>
                            <h4 class="mb-0">97.2%</h4>
                        </div>
                        <div>
                            <i class="bi bi-graph-up display-6 opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark">
                    <h5 class="card-title mb-0">Order Screening Settings</h5>
                </div>
                <div class="card-body">
                    <form id="order-screening-form">
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="order_screening_enabled" name="order_screening_enabled" {% if security_settings.order_screening_enabled %}checked{% endif %}>
                                <label class="form-check-label" for="order_screening_enabled">Enable Order Screening</label>
                            </div>
                            <small class="form-text text-muted">Screen orders for potential fraud indicators before processing.</small>
                        </div>
                        <div class="mb-3">
                            <label for="screening_level" class="form-label">Screening Sensitivity</label>
                            <select class="form-select" id="screening_level" name="screening_level">
                                <option value="low">Low - Only flag highly suspicious orders</option>
                                <option value="medium" selected>Medium - Balance between security and conversion</option>
                                <option value="high">High - Flag any potentially suspicious activity</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="screening_action" class="form-label">Default Action for Flagged Orders</label>
                            <select class="form-select" id="screening_action" name="screening_action">
                                <option value="hold">Hold for Review</option>
                                <option value="cancel">Cancel Automatically</option>
                                <option value="mark" selected>Mark as Suspicious but Process</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="notify_admin" name="notify_admin" checked>
                                <label class="form-check-label" for="notify_admin">Notify Admin on Suspicious Orders</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="transaction_threshold_alert" class="form-label">High-Value Transaction Threshold ($)</label>
                            <input type="number" class="form-control" id="transaction_threshold_alert" name="transaction_threshold_alert" value="{{ security_settings.transaction_threshold_alert|default('1000') }}">
                            <small class="form-text text-muted">Orders above this amount will trigger additional verification.</small>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark">
                    <h5 class="card-title mb-0">IP & Device Verification</h5>
                </div>
                <div class="card-body">
                    <form id="ip-verification-form">
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="ip_reputation_checking" name="ip_reputation_checking" {% if security_settings.ip_reputation_checking %}checked{% endif %}>
                                <label class="form-check-label" for="ip_reputation_checking">Enable IP Reputation Checking</label>
                            </div>
                            <small class="form-text text-muted">Check IP addresses against known bad actors and proxies.</small>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="device_fingerprinting" name="device_fingerprinting" {% if security_settings.device_fingerprinting %}checked{% endif %}>
                                <label class="form-check-label" for="device_fingerprinting">Enable Device Fingerprinting</label>
                            </div>
                            <small class="form-text text-muted">Track and analyze device characteristics for unusual patterns.</small>
                        </div>
                        <div class="mb-3">
                            <label for="ip_block_list" class="form-label">Blocked IP Addresses/Ranges</label>
                            <textarea class="form-control" id="ip_block_list" name="ip_block_list" rows="3">203.0.113.0/24
198.51.100.0/24
185.143.223.0/24
91.243.90.0/24</textarea>
                        </div>
                        <div class="mb-3">
                            <label for="location_risk" class="form-label">High Risk Locations</label>
                            <select class="form-select" id="location_risk" name="location_risk" multiple>
                                <option value="anonymous_proxy" selected>Anonymous Proxies</option>
                                <option value="satellite_provider">Satellite Providers</option>
                                <option value="high_risk_countries" selected>High Risk Countries</option>
                            </select>
                            <small class="form-text text-muted">Orders from these locations will receive additional scrutiny.</small>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark">
                    <h5 class="card-title mb-0">Velocity Checks & Patterns</h5>
                </div>
                <div class="card-body">
                    <form id="velocity-checks-form">
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="velocity_checking" name="velocity_checking" {% if security_settings.velocity_checking %}checked{% endif %}>
                                <label class="form-check-label" for="velocity_checking">Enable Velocity Checking</label>
                            </div>
                            <small class="form-text text-muted">Flag suspicious patterns of rapid order creation.</small>
                        </div>
                        <div class="mb-3">
                            <label for="max_orders_per_hour" class="form-label">Maximum Orders Per Hour (Same User)</label>
                            <input type="number" class="form-control" id="max_orders_per_hour" name="max_orders_per_hour" value="5">
                        </div>
                        <div class="mb-3">
                            <label for="max_orders_per_day" class="form-label">Maximum Orders Per Day (Same User)</label>
                            <input type="number" class="form-control" id="max_orders_per_day" name="max_orders_per_day" value="20">
                        </div>
                        <div class="mb-3">
                            <label for="max_cards_per_account" class="form-label">Maximum Payment Cards Per Account</label>
                            <input type="number" class="form-control" id="max_cards_per_account" name="max_cards_per_account" value="5">
                        </div>
                        <div class="mb-3">
                            <label for="max_addresses_per_account" class="form-label">Maximum Shipping Addresses Per Account</label>
                            <input type="number" class="form-control" id="max_addresses_per_account" name="max_addresses_per_account" value="10">
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="detect_card_testing" name="detect_card_testing" checked>
                                <label class="form-check-label" for="detect_card_testing">Detect Card Testing Patterns</label>
                            </div>
                            <small class="form-text text-muted">Identify patterns of rapid small transactions used to test stolen cards.</small>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark">
                    <h5 class="card-title mb-0">Address Verification & Customer Data</h5>
                </div>
                <div class="card-body">
                    <form id="address-verification-form">
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="address_verification" name="address_verification" {% if security_settings.address_verification %}checked{% endif %}>
                                <label class="form-check-label" for="address_verification">Enable Address Verification (AVS)</label>
                            </div>
                            <small class="form-text text-muted">Verify billing address matches the payment card's registered address.</small>
                        </div>
                        <div class="mb-3">
                            <label for="avs_action" class="form-label">AVS Failure Action</label>
                            <select class="form-select" id="avs_action" name="avs_action">
                                <option value="reject">Reject Transaction</option>
                                <option value="flag" selected>Flag for Review</option>
                                <option value="ignore">Allow but Log</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="require_cvv" name="require_cvv" checked>
                                <label class="form-check-label" for="require_cvv">Require CVV for Card Transactions</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="check_shipping_billing_match" name="check_shipping_billing_match" checked>
                                <label class="form-check-label" for="check_shipping_billing_match">Flag When Shipping/Billing Addresses Differ</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="phone_verification" name="phone_verification" checked>
                                <label class="form-check-label" for="phone_verification">Enable Phone Number Verification</label>
                            </div>
                            <small class="form-text text-muted">Verify phone numbers are valid for the provided country.</small>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="email_risk_check" name="email_risk_check" checked>
                                <label class="form-check-label" for="email_risk_check">Check Email Risk Profile</label>
                            </div>
                            <small class="form-text text-muted">Verify email addresses against disposable email services and fraud databases.</small>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark">
                    <h5 class="card-title mb-0">Recent Fraud Alerts</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Date/Time</th>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>IP Address</th>
                                    <th>Risk Factors</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>2025-04-22 10:15:32</td>
                                    <td><a href="#">ORD-12345</a></td>
                                    <td>customer@example.com</td>
                                    <td>203.0.113.42</td>
                                    <td>High-value order, IP mismatch, multiple attempts</td>
                                    <td><span class="badge bg-danger">Blocked</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-secondary">Details</button>
                                        <button class="btn btn-sm btn-outline-success">Approve</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>2025-04-22 09:23:17</td>
                                    <td><a href="#">ORD-12344</a></td>
                                    <td>user123@example.com</td>
                                    <td>198.51.100.75</td>
                                    <td>AVS failure, suspicious location</td>
                                    <td><span class="badge bg-warning">Under Review</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-secondary">Details</button>
                                        <button class="btn btn-sm btn-outline-success">Approve</button>
                                        <button class="btn btn-sm btn-outline-danger">Block</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>2025-04-21 16:47:05</td>
                                    <td><a href="#">ORD-12338</a></td>
                                    <td>newbuyer22@example.com</td>
                                    <td>192.168.1.254</td>
                                    <td>Multiple shipping addresses, velocity check</td>
                                    <td><span class="badge bg-success">Approved</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-secondary">Details</button>
                                        <button class="btn btn-sm btn-outline-danger">Block</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle form submission
    document.getElementById('save-fraud-settings').addEventListener('click', function() {
        const orderScreeningForm = document.getElementById('order-screening-form');
        const ipVerificationForm = document.getElementById('ip-verification-form');
        const velocityChecksForm = document.getElementById('velocity-checks-form');
        const addressVerificationForm = document.getElementById('address-verification-form');
        
        const formData = new FormData();
        
        // Collect data from all forms
        [orderScreeningForm, ipVerificationForm, velocityChecksForm, addressVerificationForm].forEach(form => {
            Array.from(form.elements).forEach(element => {
                if (element.name) {
                    if (element.type === 'checkbox') {
                        formData.append(element.name, element.checked ? 'on' : '');
                    } else {
                        formData.append(element.name, element.value);
                    }
                }
            });
        });
        
        // Submit form data
        fetch('/admin/security/save', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Fraud detection settings saved successfully!');
            } else {
                alert('Error saving settings: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving settings.');
        });
    });
});
</script>
{% endblock %}