{% extends "admin/base.html" %}

{% block title %}Security Health Monitoring - PyCommerce Admin{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
        <h1 class="h2"><i class="bi bi-heart-pulse me-2"></i>Security Health Monitoring</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <a href="/admin/security" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i> Back to Security
                </a>
                <button type="button" class="btn btn-sm btn-outline-primary" id="refresh-security">
                    <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                </button>
                <button type="button" class="btn btn-sm btn-primary" id="save-health-settings">
                    <i class="bi bi-save me-1"></i> Save Settings
                </button>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary bg-gradient text-white shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">Overall Security Score</h6>
                            <h4 class="mb-0">{{ security_settings.security_score|default('85') }}%</h4>
                        </div>
                        <div>
                            <i class="bi bi-shield-check display-6 opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success bg-gradient text-white shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">Last Security Audit</h6>
                            <h4 class="mb-0">{{ security_settings.last_security_audit|default('2025-03-01') }}</h4>
                        </div>
                        <div>
                            <i class="bi bi-calendar-check display-6 opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning bg-gradient text-white shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">Vulnerabilities</h6>
                            <h4 class="mb-0">3 Open</h4>
                        </div>
                        <div>
                            <i class="bi bi-bug display-6 opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info bg-gradient text-white shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">Compliance Status</h6>
                            <h4 class="mb-0">Active</h4>
                        </div>
                        <div>
                            <i class="bi bi-check2-circle display-6 opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-dark">
                    <h5 class="card-title mb-0">Security Health Dashboard</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div style="height: 320px; background-color: #f8f9fa; border-radius: 4px; display: flex; justify-content: center; align-items: center;">
                                <div class="text-center">
                                    <h5>Security Score Trend (Last 90 Days)</h5>
                                    <div style="height: 220px; display: flex; align-items: flex-end; justify-content: space-between; padding: 0 20px;">
                                        <div style="width: 3%; height: 70%; background-color: #6c757d; margin: 0 2px;"></div>
                                        <div style="width: 3%; height: 72%; background-color: #6c757d; margin: 0 2px;"></div>
                                        <div style="width: 3%; height: 68%; background-color: #6c757d; margin: 0 2px;"></div>
                                        <div style="width: 3%; height: 65%; background-color: #6c757d; margin: 0 2px;"></div>
                                        <div style="width: 3%; height: 70%; background-color: #6c757d; margin: 0 2px;"></div>
                                        <div style="width: 3%; height: 75%; background-color: #6c757d; margin: 0 2px;"></div>
                                        <div style="width: 3%; height: 78%; background-color: #6c757d; margin: 0 2px;"></div>
                                        <div style="width: 3%; height: 80%; background-color: #6c757d; margin: 0 2px;"></div>
                                        <div style="width: 3%; height: 82%; background-color: #6c757d; margin: 0 2px;"></div>
                                        <div style="width: 3%; height: 80%; background-color: #6c757d; margin: 0 2px;"></div>
                                        <div style="width: 3%; height: 78%; background-color: #6c757d; margin: 0 2px;"></div>
                                        <div style="width: 3%; height: 82%; background-color: #6c757d; margin: 0 2px;"></div>
                                        <div style="width: 3%; height: 85%; background-color: #0d6efd; margin: 0 2px;"></div>
                                    </div>
                                    <div class="text-muted">Chart placeholder: In a real implementation, use Chart.js or similar library</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h5>Security Score Breakdown</h5>
                            <div class="mb-3">
                                <label class="form-label d-flex justify-content-between">Authentication & Access Control <span class="text-primary">90%</span></label>
                                <div class="progress">
                                    <div class="progress-bar bg-primary" role="progressbar" style="width: 90%" aria-valuenow="90" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label d-flex justify-content-between">Data Protection <span class="text-primary">85%</span></label>
                                <div class="progress">
                                    <div class="progress-bar bg-primary" role="progressbar" style="width: 85%" aria-valuenow="85" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label d-flex justify-content-between">Payment Security <span class="text-primary">95%</span></label>
                                <div class="progress">
                                    <div class="progress-bar bg-primary" role="progressbar" style="width: 95%" aria-valuenow="95" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label d-flex justify-content-between">Fraud Prevention <span class="text-success">88%</span></label>
                                <div class="progress">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: 88%" aria-valuenow="88" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label d-flex justify-content-between">Infrastructure Security <span class="text-warning">70%</span></label>
                                <div class="progress">
                                    <div class="progress-bar bg-warning" role="progressbar" style="width: 70%" aria-valuenow="70" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label d-flex justify-content-between">Compliance <span class="text-success">92%</span></label>
                                <div class="progress">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: 92%" aria-valuenow="92" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark">
                    <h5 class="card-title mb-0">Automated Security Scanning</h5>
                </div>
                <div class="card-body">
                    <form id="security-scanning-form">
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="automated_security_scanning" name="automated_security_scanning" {% if security_settings.automated_security_scanning %}checked{% endif %}>
                                <label class="form-check-label" for="automated_security_scanning">Enable Automated Security Scanning</label>
                            </div>
                            <small class="form-text text-muted">Run regular automated security scans to detect vulnerabilities.</small>
                        </div>
                        <div class="mb-3">
                            <label for="vulnerability_assessment_freq" class="form-label">Vulnerability Assessment Frequency</label>
                            <select class="form-select" id="vulnerability_assessment_freq" name="vulnerability_assessment_freq">
                                <option value="weekly">Weekly</option>
                                <option value="biweekly">Bi-weekly</option>
                                <option value="monthly" {% if security_settings.vulnerability_assessment_freq == 'monthly' %}selected{% endif %}>Monthly</option>
                                <option value="quarterly">Quarterly</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="scan_coverage" class="form-label">Scan Coverage</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="scan_authentication" name="scan_authentication" checked>
                                <label class="form-check-label" for="scan_authentication">Authentication Systems</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="scan_payment" name="scan_payment" checked>
                                <label class="form-check-label" for="scan_payment">Payment Systems</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="scan_api" name="scan_api" checked>
                                <label class="form-check-label" for="scan_api">API Endpoints</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="scan_webapp" name="scan_webapp" checked>
                                <label class="form-check-label" for="scan_webapp">Web Application</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="scan_infrastructure" name="scan_infrastructure" checked>
                                <label class="form-check-label" for="scan_infrastructure">Infrastructure</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="scan_severity_threshold" class="form-label">Alert on Severity Level</label>
                            <select class="form-select" id="scan_severity_threshold" name="scan_severity_threshold">
                                <option value="critical">Critical Only</option>
                                <option value="high" selected>High and Above</option>
                                <option value="medium">Medium and Above</option>
                                <option value="low">All Findings</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="penetration_testing" name="penetration_testing" checked>
                                <label class="form-check-label" for="penetration_testing">Schedule Regular Penetration Testing</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="penetration_testing_frequency" class="form-label">Penetration Testing Frequency</label>
                            <select class="form-select" id="penetration_testing_frequency" name="penetration_testing_frequency">
                                <option value="quarterly">Quarterly</option>
                                <option value="biannual" selected>Bi-annually</option>
                                <option value="annual">Annually</option>
                            </select>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark">
                    <h5 class="card-title mb-0">Security Notifications</h5>
                </div>
                <div class="card-body">
                    <form id="security-notifications-form">
                        <div class="mb-3">
                            <label for="notification_recipients" class="form-label">Security Alert Recipients</label>
                            <input type="text" class="form-control" id="notification_recipients" name="notification_recipients" value="security@example.com, admin@example.com, cto@example.com">
                            <small class="form-text text-muted">Email addresses to receive security alerts (comma separated).</small>
                        </div>
                        <div class="mb-3">
                            <label for="notification_channels" class="form-label">Notification Channels</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="notify_email" name="notify_email" checked>
                                <label class="form-check-label" for="notify_email">Email</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="notify_sms" name="notify_sms" checked>
                                <label class="form-check-label" for="notify_sms">SMS</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="notify_slack" name="notify_slack" checked>
                                <label class="form-check-label" for="notify_slack">Slack</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="notify_dashboard" name="notify_dashboard" checked>
                                <label class="form-check-label" for="notify_dashboard">Dashboard Alert</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="notification_severity" class="form-label">Notification Severity</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="severity_critical" name="severity_critical" checked>
                                <label class="form-check-label" for="severity_critical">Critical</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="severity_high" name="severity_high" checked>
                                <label class="form-check-label" for="severity_high">High</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="severity_medium" name="severity_medium" checked>
                                <label class="form-check-label" for="severity_medium">Medium</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="severity_low" name="severity_low">
                                <label class="form-check-label" for="severity_low">Low</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="security_digest" name="security_digest" checked>
                                <label class="form-check-label" for="security_digest">Send Weekly Security Digest</label>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark">
                    <h5 class="card-title mb-0">Compliance Monitoring</h5>
                </div>
                <div class="card-body">
                    <form id="compliance-monitoring-form">
                        <div class="mb-3">
                            <label for="compliance_frameworks" class="form-label">Compliance Frameworks</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="pci_dss" name="pci_dss" checked>
                                <label class="form-check-label" for="pci_dss">PCI DSS</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="gdpr" name="gdpr" checked>
                                <label class="form-check-label" for="gdpr">GDPR</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="ccpa" name="ccpa" checked>
                                <label class="form-check-label" for="ccpa">CCPA</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="hipaa" name="hipaa">
                                <label class="form-check-label" for="hipaa">HIPAA</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="soc2" name="soc2">
                                <label class="form-check-label" for="soc2">SOC 2</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="pci_compliance_expiry" class="form-label">PCI DSS Compliance Expiry Date</label>
                            <input type="date" class="form-control" id="pci_compliance_expiry" name="pci_compliance_expiry" value="{{ security_settings.pci_compliance_expiry|default('2025-12-31') }}">
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="gdpr_compliance_verified" name="gdpr_compliance_verified" {% if security_settings.gdpr_compliance_verified %}checked{% endif %}>
                                <label class="form-check-label" for="gdpr_compliance_verified">GDPR Compliance Verified</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="compliance_contact" class="form-label">Compliance Contact</label>
                            <input type="email" class="form-control" id="compliance_contact" name="compliance_contact" value="compliance@example.com">
                        </div>
                        <div class="mb-3">
                            <label for="last_security_audit" class="form-label">Last Security Audit Date</label>
                            <input type="date" class="form-control" id="last_security_audit" name="last_security_audit" value="{{ security_settings.last_security_audit|default('2025-03-01') }}">
                        </div>
                        <div class="mb-3">
                            <label for="next_security_audit" class="form-label">Next Scheduled Audit</label>
                            <input type="date" class="form-control" id="next_security_audit" name="next_security_audit" value="2025-09-01">
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark">
                    <h5 class="card-title mb-0">Security Metrics & Reporting</h5>
                </div>
                <div class="card-body">
                    <form id="security-metrics-form">
                        <div class="mb-3">
                            <label for="security_key_metrics" class="form-label">Key Security Metrics to Track</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="track_security_incidents" name="track_security_incidents" checked>
                                <label class="form-check-label" for="track_security_incidents">Security Incidents</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="track_vulnerabilities" name="track_vulnerabilities" checked>
                                <label class="form-check-label" for="track_vulnerabilities">Vulnerabilities</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="track_patch_times" name="track_patch_times" checked>
                                <label class="form-check-label" for="track_patch_times">Patch Implementation Times</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="track_compliance" name="track_compliance" checked>
                                <label class="form-check-label" for="track_compliance">Compliance Status</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="track_access_control" name="track_access_control" checked>
                                <label class="form-check-label" for="track_access_control">Access Control Violations</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="track_fraud_attempts" name="track_fraud_attempts" checked>
                                <label class="form-check-label" for="track_fraud_attempts">Fraud Attempts</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="monthly_security_report" name="monthly_security_report" checked>
                                <label class="form-check-label" for="monthly_security_report">Generate Monthly Security Report</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="executive_summary" name="executive_summary" checked>
                                <label class="form-check-label" for="executive_summary">Include Executive Summary</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="report_distribution" class="form-label">Report Distribution List</label>
                            <input type="text" class="form-control" id="report_distribution" name="report_distribution" value="executive@example.com, security@example.com, management@example.com">
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="security_trends_analysis" name="security_trends_analysis" checked>
                                <label class="form-check-label" for="security_trends_analysis">Enable Security Trends Analysis</label>
                            </div>
                            <small class="form-text text-muted">Analyze security metrics over time to identify trends and patterns.</small>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark">
                    <h5 class="card-title mb-0">Recent Vulnerabilities</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Discovered</th>
                                    <th>Type</th>
                                    <th>Component</th>
                                    <th>Severity</th>
                                    <th>Status</th>
                                    <th>Remediation</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>VLN-2025-042</td>
                                    <td>2025-04-15</td>
                                    <td>XSS Vulnerability</td>
                                    <td>Product Review Form</td>
                                    <td><span class="badge bg-danger">Critical</span></td>
                                    <td><span class="badge bg-warning">In Progress</span></td>
                                    <td>Input sanitization patch being tested</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-secondary">Details</button>
                                        <button class="btn btn-sm btn-outline-primary">Prioritize</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>VLN-2025-038</td>
                                    <td>2025-04-10</td>
                                    <td>Outdated Library</td>
                                    <td>Payment Processing</td>
                                    <td><span class="badge bg-warning">High</span></td>
                                    <td><span class="badge bg-success">Fixed</span></td>
                                    <td>Updated to latest library version</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-secondary">Details</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>VLN-2025-035</td>
                                    <td>2025-04-05</td>
                                    <td>CSRF</td>
                                    <td>Account Settings</td>
                                    <td><span class="badge bg-warning">High</span></td>
                                    <td><span class="badge bg-warning">In Progress</span></td>
                                    <td>Implementing CSRF tokens</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-secondary">Details</button>
                                        <button class="btn btn-sm btn-outline-primary">Prioritize</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle form submission
    document.getElementById('save-health-settings').addEventListener('click', function() {
        const securityScanningForm = document.getElementById('security-scanning-form');
        const securityNotificationsForm = document.getElementById('security-notifications-form');
        const complianceMonitoringForm = document.getElementById('compliance-monitoring-form');
        const securityMetricsForm = document.getElementById('security-metrics-form');
        
        const formData = new FormData();
        
        // Collect data from all forms
        [securityScanningForm, securityNotificationsForm, complianceMonitoringForm, securityMetricsForm].forEach(form => {
            Array.from(form.elements).forEach(element => {
                if (element.name) {
                    if (element.type === 'checkbox') {
                        formData.append(element.name, element.checked ? 'on' : '');
                    } else {
                        formData.append(element.name, element.value);
                    }
                }
            });
        });
        
        // Submit form data
        fetch('/admin/security/save', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Security health monitoring settings saved successfully!');
            } else {
                alert('Error saving settings: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving settings.');
        });
    });
});
</script>
{% endblock %}