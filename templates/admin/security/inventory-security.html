{% extends "admin/base.html" %}

{% block title %}Inventory Security - PyCommerce Admin{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
        <h1 class="h2"><i class="bi bi-box-seam-fill me-2"></i>Inventory Security Settings</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <a href="/admin/security" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i> Back to Security
                </a>
                <button type="button" class="btn btn-sm btn-outline-primary" id="refresh-security">
                    <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                </button>
                <button type="button" class="btn btn-sm btn-primary" id="save-inventory-settings">
                    <i class="bi bi-save me-1"></i> Save Settings
                </button>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary bg-gradient text-white shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">Inventory Security Status</h6>
                            <h4 class="mb-0">Good</h4>
                        </div>
                        <div>
                            <i class="bi bi-shield-check display-6 opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success bg-gradient text-white shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">Blocked Manipulation Attempts</h6>
                            <h4 class="mb-0">17 (Last 30 days)</h4>
                        </div>
                        <div>
                            <i class="bi bi-shield-x display-6 opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning bg-gradient text-white shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">Cart Abandonment Rate</h6>
                            <h4 class="mb-0">68.2%</h4>
                        </div>
                        <div>
                            <i class="bi bi-cart-x display-6 opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info bg-gradient text-white shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">Low Stock Alerts</h6>
                            <h4 class="mb-0">8 Active</h4>
                        </div>
                        <div>
                            <i class="bi bi-exclamation-circle display-6 opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark">
                    <h5 class="card-title mb-0">Inventory Protection Settings</h5>
                </div>
                <div class="card-body">
                    <form id="inventory-protection-form">
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="inventory_manipulation_protection" name="inventory_manipulation_protection" {% if security_settings.inventory_manipulation_protection %}checked{% endif %}>
                                <label class="form-check-label" for="inventory_manipulation_protection">Enable Inventory Manipulation Protection</label>
                            </div>
                            <small class="form-text text-muted">Protect against inventory exploitation vulnerabilities.</small>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="reserve_inventory_in_cart" name="reserve_inventory_in_cart" checked>
                                <label class="form-check-label" for="reserve_inventory_in_cart">Reserve Inventory in Cart</label>
                            </div>
                            <small class="form-text text-muted">Temporarily reserve inventory when items are added to cart.</small>
                        </div>
                        <div class="mb-3">
                            <label for="cart_reservation_time" class="form-label">Cart Reservation Time (Minutes)</label>
                            <input type="number" class="form-control" id="cart_reservation_time" name="cart_reservation_time" value="15" min="1" max="120">
                            <small class="form-text text-muted">How long items are reserved in cart before being released.</small>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="prevent_negative_inventory" name="prevent_negative_inventory" checked>
                                <label class="form-check-label" for="prevent_negative_inventory">Prevent Negative Inventory</label>
                            </div>
                            <small class="form-text text-muted">Block orders that would result in negative inventory levels.</small>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="inventory_alert_threshold" name="inventory_alert_threshold" checked>
                                <label class="form-check-label" for="inventory_alert_threshold">Enable Low Stock Alerts</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="inventory_alert_threshold_value" class="form-label">Low Stock Alert Threshold</label>
                            <input type="number" class="form-control" id="inventory_alert_threshold_value" name="inventory_alert_threshold_value" value="{{ security_settings.inventory_alert_threshold|default('5') }}" min="1" max="100">
                            <small class="form-text text-muted">Send alerts when stock drops below this level.</small>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="inventory_change_logging" name="inventory_change_logging" checked>
                                <label class="form-check-label" for="inventory_change_logging">Log All Inventory Changes</label>
                            </div>
                            <small class="form-text text-muted">Maintain a detailed audit trail of all inventory modifications.</small>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark">
                    <h5 class="card-title mb-0">Stock Management Security</h5>
                </div>
                <div class="card-body">
                    <form id="stock-management-form">
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="stock_adjustment_approval" name="stock_adjustment_approval" checked>
                                <label class="form-check-label" for="stock_adjustment_approval">Require Approval for Large Stock Adjustments</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="stock_adjustment_threshold" class="form-label">Large Adjustment Threshold (%)</label>
                            <input type="number" class="form-control" id="stock_adjustment_threshold" name="stock_adjustment_threshold" value="20" min="1" max="100">
                            <small class="form-text text-muted">Percentage change that requires approval.</small>
                        </div>
                        <div class="mb-3">
                            <label for="inventory_reconciliation_frequency" class="form-label">Inventory Reconciliation Frequency</label>
                            <select class="form-select" id="inventory_reconciliation_frequency" name="inventory_reconciliation_frequency">
                                <option value="daily">Daily</option>
                                <option value="weekly" selected>Weekly</option>
                                <option value="biweekly">Bi-weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                            <small class="form-text text-muted">How often to perform inventory reconciliation checks.</small>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="notify_inventory_discrepancy" name="notify_inventory_discrepancy" checked>
                                <label class="form-check-label" for="notify_inventory_discrepancy">Notify on Inventory Discrepancies</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="discrepancy_threshold" class="form-label">Discrepancy Alert Threshold (%)</label>
                            <input type="number" class="form-control" id="discrepancy_threshold" name="discrepancy_threshold" value="5" min="1" max="50">
                            <small class="form-text text-muted">Alert when discrepancies exceed this percentage.</small>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark">
                    <h5 class="card-title mb-0">Price Tampering Prevention</h5>
                </div>
                <div class="card-body">
                    <form id="price-tampering-form">
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="price_tampering_detection" name="price_tampering_detection" {% if security_settings.price_tampering_detection %}checked{% endif %}>
                                <label class="form-check-label" for="price_tampering_detection">Enable Price Tampering Detection</label>
                            </div>
                            <small class="form-text text-muted">Detect and prevent client-side price manipulation attempts.</small>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="price_verification_checkout" name="price_verification_checkout" checked>
                                <label class="form-check-label" for="price_verification_checkout">Verify Prices at Checkout</label>
                            </div>
                            <small class="form-text text-muted">Re-verify all prices at checkout against the database.</small>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="encrypt_price_parameters" name="encrypt_price_parameters" checked>
                                <label class="form-check-label" for="encrypt_price_parameters">Encrypt Price Parameters</label>
                            </div>
                            <small class="form-text text-muted">Encrypt price data in client-side requests.</small>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="sign_price_data" name="sign_price_data" checked>
                                <label class="form-check-label" for="sign_price_data">Sign Price Data</label>
                            </div>
                            <small class="form-text text-muted">Cryptographically sign price information to prevent tampering.</small>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="log_price_discrepancies" name="log_price_discrepancies" checked>
                                <label class="form-check-label" for="log_price_discrepancies">Log Price Discrepancies</label>
                            </div>
                            <small class="form-text text-muted">Record all instances of price mismatches between client and server.</small>
                        </div>
                        <div class="mb-3">
                            <label for="price_change_approval" class="form-label">Price Change Approval</label>
                            <select class="form-select" id="price_change_approval" name="price_change_approval">
                                <option value="none">No approval required</option>
                                <option value="significant" selected>Only for significant changes (>10%)</option>
                                <option value="all">All price changes require approval</option>
                            </select>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark">
                    <h5 class="card-title mb-0">Cart Protection & Monitoring</h5>
                </div>
                <div class="card-body">
                    <form id="cart-protection-form">
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="cart_abandonment_monitoring" name="cart_abandonment_monitoring" {% if security_settings.cart_abandonment_monitoring %}checked{% endif %}>
                                <label class="form-check-label" for="cart_abandonment_monitoring">Enable Cart Abandonment Monitoring</label>
                            </div>
                            <small class="form-text text-muted">Track and analyze cart abandonment patterns to detect potential issues.</small>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="detect_cart_manipulation" name="detect_cart_manipulation" checked>
                                <label class="form-check-label" for="detect_cart_manipulation">Detect Cart Manipulation</label>
                            </div>
                            <small class="form-text text-muted">Detect attempts to manipulate cart contents or quantities.</small>
                        </div>
                        <div class="mb-3">
                            <label for="max_cart_quantity" class="form-label">Maximum Quantity Per Item</label>
                            <input type="number" class="form-control" id="max_cart_quantity" name="max_cart_quantity" value="50" min="1" max="1000">
                            <small class="form-text text-muted">Maximum allowed quantity for a single item in cart.</small>
                        </div>
                        <div class="mb-3">
                            <label for="max_cart_items" class="form-label">Maximum Items in Cart</label>
                            <input type="number" class="form-control" id="max_cart_items" name="max_cart_items" value="100" min="1" max="1000">
                            <small class="form-text text-muted">Maximum number of unique items allowed in cart.</small>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="detect_bot_checkout" name="detect_bot_checkout" checked>
                                <label class="form-check-label" for="detect_bot_checkout">Detect Bot Checkout Attempts</label>
                            </div>
                            <small class="form-text text-muted">Identify and prevent automated checkout bots.</small>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="cart_expiration" name="cart_expiration" checked>
                                <label class="form-check-label" for="cart_expiration">Enable Cart Expiration</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="cart_expiration_time" class="form-label">Cart Expiration Time (Hours)</label>
                            <input type="number" class="form-control" id="cart_expiration_time" name="cart_expiration_time" value="24" min="1" max="168">
                            <small class="form-text text-muted">Time after which abandoned carts are automatically cleared.</small>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark">
                    <h5 class="card-title mb-0">Recent Inventory Security Events</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Date/Time</th>
                                    <th>Event Type</th>
                                    <th>Product</th>
                                    <th>User/IP</th>
                                    <th>Details</th>
                                    <th>Action Taken</th>
                                    <th>Review</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>2025-04-22 09:12:45</td>
                                    <td>Price Tampering Attempt</td>
                                    <td>Premium Headphones X7</td>
                                    <td>203.0.113.42</td>
                                    <td>Client sent price: $49.99, Server price: $249.99</td>
                                    <td><span class="badge bg-danger">Order Blocked</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-secondary">Details</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>2025-04-21 15:37:22</td>
                                    <td>Inventory Manipulation</td>
                                    <td>Designer Watch Model Z</td>
                                    <td>198.51.100.75</td>
                                    <td>Attempted to add 9999 units to cart (max stock: 12)</td>
                                    <td><span class="badge bg-warning">Limited to Available</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-secondary">Details</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>2025-04-21 11:23:14</td>
                                    <td>Low Stock Alert</td>
                                    <td>Bluetooth Speaker Mini</td>
                                    <td>admin@example.com</td>
                                    <td>Stock level dropped to 4 units (threshold: 5)</td>
                                    <td><span class="badge bg-info">Notification Sent</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-secondary">Details</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle form submission
    document.getElementById('save-inventory-settings').addEventListener('click', function() {
        const inventoryProtectionForm = document.getElementById('inventory-protection-form');
        const stockManagementForm = document.getElementById('stock-management-form');
        const priceTamperingForm = document.getElementById('price-tampering-form');
        const cartProtectionForm = document.getElementById('cart-protection-form');
        
        const formData = new FormData();
        
        // Collect data from all forms
        [inventoryProtectionForm, stockManagementForm, priceTamperingForm, cartProtectionForm].forEach(form => {
            Array.from(form.elements).forEach(element => {
                if (element.name) {
                    if (element.type === 'checkbox') {
                        formData.append(element.name, element.checked ? 'on' : '');
                    } else {
                        formData.append(element.name, element.value);
                    }
                }
            });
        });
        
        // Submit form data
        fetch('/admin/security/save', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Inventory security settings saved successfully!');
            } else {
                alert('Error saving settings: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving settings.');
        });
    });
});
</script>
{% endblock %}