{% extends "admin/base.html" %}

{% block title %}Account Security - PyCommerce Admin{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
        <h1 class="h2"><i class="bi bi-person-lock me-2"></i>Customer Account Security</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <a href="/admin/security" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i> Back to Security
                </a>
                <button type="button" class="btn btn-sm btn-outline-primary" id="refresh-security">
                    <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                </button>
                <button type="button" class="btn btn-sm btn-primary" id="save-account-settings">
                    <i class="bi bi-save me-1"></i> Save Settings
                </button>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary bg-gradient text-white shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">Account Security Status</h6>
                            <h4 class="mb-0">Strong</h4>
                        </div>
                        <div>
                            <i class="bi bi-shield-lock display-6 opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success bg-gradient text-white shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">Accounts with MFA</h6>
                            <h4 class="mb-0">78%</h4>
                        </div>
                        <div>
                            <i class="bi bi-phone-fill display-6 opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning bg-gradient text-white shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">Suspicious Login Alerts</h6>
                            <h4 class="mb-0">4 (Last 7 days)</h4>
                        </div>
                        <div>
                            <i class="bi bi-exclamation-triangle display-6 opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info bg-gradient text-white shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">Account Recovery Rate</h6>
                            <h4 class="mb-0">98.5%</h4>
                        </div>
                        <div>
                            <i class="bi bi-arrow-counterclockwise display-6 opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark">
                    <h5 class="card-title mb-0">Account Protection Settings</h5>
                </div>
                <div class="card-body">
                    <form id="account-protection-form">
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="account_takeover_protection" name="account_takeover_protection" {% if security_settings.account_takeover_protection %}checked{% endif %}>
                                <label class="form-check-label" for="account_takeover_protection">Enable Account Takeover Protection</label>
                            </div>
                            <small class="form-text text-muted">Detect and prevent unauthorized account access attempts.</small>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="suspicious_login_alerts" name="suspicious_login_alerts" {% if security_settings.suspicious_login_alerts %}checked{% endif %}>
                                <label class="form-check-label" for="suspicious_login_alerts">Enable Suspicious Login Alerts</label>
                            </div>
                            <small class="form-text text-muted">Send alerts when suspicious login activity is detected.</small>
                        </div>
                        <div class="mb-3">
                            <label for="suspicious_factors" class="form-label">Suspicious Factors to Monitor</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="new_location" name="new_location" checked>
                                <label class="form-check-label" for="new_location">New Geographic Location</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="new_device" name="new_device" checked>
                                <label class="form-check-label" for="new_device">New Device</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="unusual_time" name="unusual_time" checked>
                                <label class="form-check-label" for="unusual_time">Unusual Time of Day</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="vpn_proxy" name="vpn_proxy" checked>
                                <label class="form-check-label" for="vpn_proxy">VPN/Proxy Usage</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="multiple_failures" name="multiple_failures" checked>
                                <label class="form-check-label" for="multiple_failures">Multiple Failed Attempts</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="login_notification_method" class="form-label">Login Notification Method</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="notify_email" name="notify_email" checked>
                                <label class="form-check-label" for="notify_email">Email</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="notify_sms" name="notify_sms">
                                <label class="form-check-label" for="notify_sms">SMS</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="notify_app" name="notify_app" checked>
                                <label class="form-check-label" for="notify_app">In-App Notification</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="new_device_notification" name="new_device_notification" {% if security_settings.new_device_notification %}checked{% endif %}>
                                <label class="form-check-label" for="new_device_notification">Notify on New Device Login</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="account_activity_notification" name="account_activity_notification" {% if security_settings.account_activity_notification %}checked{% endif %}>
                                <label class="form-check-label" for="account_activity_notification">Send Account Activity Notifications</label>
                            </div>
                            <small class="form-text text-muted">Notify customers of significant account changes (password, email, shipping address, etc.)</small>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark">
                    <h5 class="card-title mb-0">Multi-Factor Authentication</h5>
                </div>
                <div class="card-body">
                    <form id="mfa-form">
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="mfa_available" name="mfa_available" checked>
                                <label class="form-check-label" for="mfa_available">Make MFA Available to Customers</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="mfa_required" name="mfa_required">
                                <label class="form-check-label" for="mfa_required">Require MFA for All Accounts</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="mfa_required_high_value" name="mfa_required_high_value" checked>
                                <label class="form-check-label" for="mfa_required_high_value">Require MFA for High-Value Purchases</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="mfa_methods" class="form-label">Available MFA Methods</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sms_mfa" name="sms_mfa" checked>
                                <label class="form-check-label" for="sms_mfa">SMS Code</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="email_mfa" name="email_mfa" checked>
                                <label class="form-check-label" for="email_mfa">Email Code</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="totp_mfa" name="totp_mfa" checked>
                                <label class="form-check-label" for="totp_mfa">Authenticator App (TOTP)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="webauthn_mfa" name="webauthn_mfa" checked>
                                <label class="form-check-label" for="webauthn_mfa">WebAuthn (Biometric/Security Key)</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="mfa_remember_device" class="form-label">Remember Device Duration</label>
                            <select class="form-select" id="mfa_remember_device" name="mfa_remember_device">
                                <option value="0">Never (Require MFA every login)</option>
                                <option value="1">1 day</option>
                                <option value="7" selected>7 days</option>
                                <option value="30">30 days</option>
                                <option value="90">90 days</option>
                            </select>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark">
                    <h5 class="card-title mb-0">Password Security</h5>
                </div>
                <div class="card-body">
                    <form id="password-security-form">
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="password_breach_detection" name="password_breach_detection" {% if security_settings.password_breach_detection %}checked{% endif %}>
                                <label class="form-check-label" for="password_breach_detection">Enable Password Breach Detection</label>
                            </div>
                            <small class="form-text text-muted">Check passwords against known data breaches (via haveibeenpwned API or similar).</small>
                        </div>
                        <div class="mb-3">
                            <label for="password_requirements" class="form-label">Password Requirements</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="min_length" name="min_length" checked>
                                <label class="form-check-label" for="min_length">Minimum Length (10 characters)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="require_uppercase" name="require_uppercase" checked>
                                <label class="form-check-label" for="require_uppercase">Uppercase Letters Required</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="require_lowercase" name="require_lowercase" checked>
                                <label class="form-check-label" for="require_lowercase">Lowercase Letters Required</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="require_numbers" name="require_numbers" checked>
                                <label class="form-check-label" for="require_numbers">Numbers Required</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="require_special" name="require_special" checked>
                                <label class="form-check-label" for="require_special">Special Characters Required</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="disallow_common" name="disallow_common" checked>
                                <label class="form-check-label" for="disallow_common">Disallow Common Passwords</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="password_history" name="password_history" checked>
                                <label class="form-check-label" for="password_history">Prevent Password Reuse</label>
                            </div>
                            <small class="form-text text-muted">Prevent users from reusing previous passwords.</small>
                        </div>
                        <div class="mb-3">
                            <label for="password_history_count" class="form-label">Remember Previous Passwords</label>
                            <select class="form-select" id="password_history_count" name="password_history_count">
                                <option value="3">Last 3 passwords</option>
                                <option value="5" selected>Last 5 passwords</option>
                                <option value="10">Last 10 passwords</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="password_age" class="form-label">Maximum Password Age</label>
                            <select class="form-select" id="password_age" name="password_age">
                                <option value="0">Never expires</option>
                                <option value="90" selected>90 days</option>
                                <option value="180">180 days</option>
                                <option value="365">365 days</option>
                            </select>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark">
                    <h5 class="card-title mb-0">Account Recovery Options</h5>
                </div>
                <div class="card-body">
                    <form id="account-recovery-form">
                        <div class="mb-3">
                            <label for="recovery_methods" class="form-label">Available Recovery Methods</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="email_recovery" name="email_recovery" checked>
                                <label class="form-check-label" for="email_recovery">Email Recovery Link</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sms_recovery" name="sms_recovery" checked>
                                <label class="form-check-label" for="sms_recovery">SMS Recovery Code</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="security_questions" name="security_questions" checked>
                                <label class="form-check-label" for="security_questions">Security Questions</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="backup_codes" name="backup_codes" checked>
                                <label class="form-check-label" for="backup_codes">Backup Recovery Codes</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="recovery_link_expiry" class="form-label">Recovery Link Expiration</label>
                            <select class="form-select" id="recovery_link_expiry" name="recovery_link_expiry">
                                <option value="1">1 hour</option>
                                <option value="4" selected>4 hours</option>
                                <option value="24">24 hours</option>
                                <option value="48">48 hours</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="rate_limit_recovery" name="rate_limit_recovery" checked>
                                <label class="form-check-label" for="rate_limit_recovery">Rate Limit Recovery Attempts</label>
                            </div>
                            <small class="form-text text-muted">Limit the number of recovery attempts to prevent brute-force attacks.</small>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="notify_on_recovery" name="notify_on_recovery" checked>
                                <label class="form-check-label" for="notify_on_recovery">Notify User on Account Recovery</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="customer_service_recovery" name="customer_service_recovery" checked>
                                <label class="form-check-label" for="customer_service_recovery">Allow Customer Service Recovery</label>
                            </div>
                            <small class="form-text text-muted">Allow customer service representatives to help with account recovery.</small>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark">
                    <h5 class="card-title mb-0">Recent Account Security Alerts</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Date/Time</th>
                                    <th>User</th>
                                    <th>Alert Type</th>
                                    <th>Source</th>
                                    <th>Details</th>
                                    <th>Resolution</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>2025-04-22 03:17:42</td>
                                    <td>user@example.com</td>
                                    <td>Suspicious Login</td>
                                    <td>203.0.113.42 (Germany)</td>
                                    <td>Login from new location, failed 2 attempts</td>
                                    <td><span class="badge bg-warning">User Notified</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-secondary">Details</button>
                                        <button class="btn btn-sm btn-outline-danger">Lock Account</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>2025-04-21 16:05:19</td>
                                    <td>customer@example.com</td>
                                    <td>Password Breach</td>
                                    <td>Breach Database</td>
                                    <td>Password found in known data breach</td>
                                    <td><span class="badge bg-success">Password Reset</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-secondary">Details</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>2025-04-20 09:32:54</td>
                                    <td>client@example.com</td>
                                    <td>Multiple Failed Logins</td>
                                    <td>198.51.100.75 (USA)</td>
                                    <td>5 failed login attempts in 2 minutes</td>
                                    <td><span class="badge bg-danger">Account Locked</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-secondary">Details</button>
                                        <button class="btn btn-sm btn-outline-success">Unlock Account</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle form submission
    document.getElementById('save-account-settings').addEventListener('click', function() {
        const accountProtectionForm = document.getElementById('account-protection-form');
        const mfaForm = document.getElementById('mfa-form');
        const passwordSecurityForm = document.getElementById('password-security-form');
        const accountRecoveryForm = document.getElementById('account-recovery-form');
        
        const formData = new FormData();
        
        // Collect data from all forms
        [accountProtectionForm, mfaForm, passwordSecurityForm, accountRecoveryForm].forEach(form => {
            Array.from(form.elements).forEach(element => {
                if (element.name) {
                    if (element.type === 'checkbox') {
                        formData.append(element.name, element.checked ? 'on' : '');
                    } else {
                        formData.append(element.name, element.value);
                    }
                }
            });
        });
        
        // Submit form data
        fetch('/admin/security/save', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Account security settings saved successfully!');
            } else {
                alert('Error saving settings: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving settings.');
        });
    });
});
</script>
{% endblock %}